# TagHere CRM - 매출 전환 기능 상세 기획안

> **작성 목적:** 현재 보유한 고객 데이터(주문내역, 전화번호, 이름, 성별, 나이, 생일, 기념일, 테이블 번호, 방문 횟수)를 활용하여 매출로 직접 전환할 수 있는 6가지 핵심 기능의 상세 기획
>
> **작성일:** 2026-02-09

---

## 목차

1. [마케팅 자동화 엔진 (Marketing Automation Engine)](#1-마케팅-자동화-엔진)
2. [고객 세그먼트 자동 분류 (RFM Smart Segments)](#2-고객-세그먼트-자동-분류)
3. [생일/기념일 자동 마케팅 (Special Day Marketing)](#3-생일기념일-자동-마케팅)
4. [재방문 주기 분석 + 스마트 넛지 (Visit Cycle Intelligence)](#4-재방문-주기-분석--스마트-넛지)
5. [추천인 프로그램 (Referral System)](#5-추천인-프로그램)
6. [매출 기여 대시보드 (Revenue Attribution Dashboard)](#6-매출-기여-대시보드)

---

# 1. 마케팅 자동화 엔진

## 1.1 문제 정의

현재 TagHere CRM은 SMS, 카카오톡 알림톡, 브랜드 메시지 등 강력한 메시징 인프라를 보유하고 있다. 하지만 **모든 캠페인이 점주의 수동 발송에 의존**하고 있어, 다음과 같은 문제가 발생한다:

- 점주가 바쁜 영업 시간에 마케팅 메시지를 만들 여유가 없다
- 이탈 위험 고객을 놓치고, 생일/기념일 같은 골든 타이밍을 활용하지 못한다
- "한 번 설정하면 알아서 돌아가는" 시스템이 없어 CRM의 실질적 매출 기여도가 낮다

## 1.2 목표

> **"점주가 한 번 설정만 켜두면, 적절한 타이밍에 적절한 고객에게 자동으로 메시지가 발송되어 재방문과 매출을 유도한다"**

## 1.3 자동화 시나리오 (Automation Rules)

### 시나리오 A: 이탈 방지 (Churn Prevention)

| 항목 | 내용 |
|------|------|
| **트리거** | 고객의 평균 방문 주기 × 1.5 경과 시 |
| **대상** | `avgVisitCycleDays`가 계산된 고객 중 `lastVisitAt`이 (avgVisitCycleDays × 1.5)일 이상 경과 |
| **액션** | 알림톡 발송 + 재방문 쿠폰 자동 생성 |
| **메시지 예시** | "OO님, 요즘 안 오셨네요! 다음 방문 시 사용 가능한 10% 할인 쿠폰을 드려요" |
| **쿠폰** | 유효기간 14일, 할인율/할인금액 점주 설정 |
| **쿨다운** | 동일 고객에게 30일 내 재발송 금지 |
| **비용** | 알림톡 1건 50원 (RetargetCoupon 단가) |
| **기대 효과** | 이탈 위험 고객 재방문율 15~25% |

### 시나리오 B: 생일 축하 (Birthday)

| 항목 | 내용 |
|------|------|
| **트리거** | 고객 생일 D-3 (3일 전) |
| **대상** | `Customer.birthday`가 3일 후인 고객 |
| **액션** | 알림톡 발송 + 생일 쿠폰 자동 생성 |
| **메시지 예시** | "OO님, 생일을 진심으로 축하드려요! 생일 맞이 특별 쿠폰을 선물합니다" |
| **쿠폰** | 유효기간: 생일 전후 7일, 할인 내용 점주 설정 |
| **쿨다운** | 연 1회 (생일 기준) |
| **비용** | 알림톡 1건 50원 |
| **기대 효과** | 생일 쿠폰 사용률 30~40%, 동반 방문으로 객단가 상승 |

### 시나리오 C: 기념일 (Anniversary)

| 항목 | 내용 |
|------|------|
| **트리거** | 기념일 D-7 (7일 전) |
| **대상** | `SurveyAnswer.valueDate` (기념일 설문)이 7일 후인 고객 |
| **액션** | 알림톡 발송 + 기념일 쿠폰 자동 생성 |
| **메시지 예시** | "OO님, 소중한 기념일이 다가오고 있어요. 특별한 날, 저희가 함께해도 될까요?" |
| **쿠폰** | 유효기간: 기념일 전후 7일, 2인 이상 방문 시 사용 가능 |
| **쿨다운** | 연 1회 (기념일 기준) |
| **비용** | 알림톡 1건 50원 |
| **기대 효과** | 기념일 = 높은 객단가 (2인 이상, 코스요리, 와인 등) |

### 시나리오 D: 첫 방문 팔로업 (First Visit Follow-up)

| 항목 | 내용 |
|------|------|
| **트리거** | 첫 방문(포인트 적립) 후 D+3 (3일 후) |
| **대상** | `Customer.visitCount == 1` 이면서 `lastVisitAt`이 3일 전인 고객 |
| **액션** | 감사 알림톡 + 재방문 쿠폰 |
| **메시지 예시** | "OO님, 지난번 방문 감사했습니다! 다음에 또 오시면 쓸 수 있는 쿠폰을 드려요" |
| **쿠폰** | 유효기간 14일 |
| **쿨다운** | 고객당 1회 (첫 방문 기준) |
| **비용** | 알림톡 1건 50원 |
| **기대 효과** | 1회 → 2회 방문 전환이 핵심 (2회 방문 시 단골 확률 급상승) |

### 시나리오 E: VIP 마일스톤 축하 (VIP Milestone)

| 항목 | 내용 |
|------|------|
| **트리거** | 방문 횟수가 10, 20, 30, 50, 100회 도달 시 |
| **대상** | `Customer.visitCount`가 마일스톤에 도달한 고객 |
| **액션** | 축하 알림톡 + 특별 보상 쿠폰 |
| **메시지 예시** | "OO님, 벌써 10번째 방문! 저희의 진짜 단골이시네요. 특별한 선물을 준비했어요" |
| **쿠폰** | 마일스톤별 차등: 10회 5%, 20회 10%, 50회 15% |
| **쿨다운** | 마일스톤별 1회 |
| **비용** | 알림톡 1건 50원 |
| **기대 효과** | VIP 유지 + 자연스러운 입소문 유발 |

### 시나리오 F: 장기 미방문 윈백 (Win-back)

| 항목 | 내용 |
|------|------|
| **트리거** | 마지막 방문으로부터 90일 이상 경과 |
| **대상** | `Customer.lastVisitAt`이 90일 이상 경과한 고객 |
| **액션** | 강력한 할인 쿠폰 + 알림톡 (마지막 시도) |
| **메시지 예시** | "OO님, 오래간만이에요. 저희가 많이 그리웠어요. 다시 만나고 싶어서 특별한 쿠폰을 준비했어요" |
| **쿠폰** | 높은 할인율 (20%+), 유효기간 30일 |
| **쿨다운** | 90일 (1회 발송 후 90일간 재발송 금지) |
| **비용** | 알림톡 1건 50원 |
| **기대 효과** | 잠자는 고객 5~10% 복귀 |

### 시나리오 G: 비수기 프로모션 (Slow Day Boost)

| 항목 | 내용 |
|------|------|
| **트리거** | 매장의 요일별 방문 패턴 분석 → 가장 한산한 요일의 전날 오전 |
| **대상** | 최근 30일 내 방문한 활성 고객 중 마케팅 동의자 |
| **액션** | SMS 또는 알림톡 발송 |
| **메시지 예시** | "내일 OO요일, {매장명}에서 깜짝 혜택을 준비했어요! 방문 시 음료 1잔 서비스" |
| **쿠폰** | 당일 한정 사용 |
| **쿨다운** | 주 1회 |
| **비용** | SMS 50원 또는 알림톡 20~50원 |
| **기대 효과** | 비수기 매출 10~20% 보완 |

## 1.4 점주 설정 화면 (UI 사양)

### 메인 화면: `/automation` (자동 마케팅)

```
┌─────────────────────────────────────────────────────────────┐
│  자동 마케팅                                    [도움말 ?]    │
│                                                             │
│  ┌─ 요약 카드 ──────────────────────────────────────────┐   │
│  │  활성화된 자동화: 3/7  │  이번 달 자동 발송: 47건       │   │
│  │  쿠폰 사용률: 23%     │  추정 추가 매출: ₩1,230,000    │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 시나리오 카드 리스트 ───────────────────────────────┐   │
│  │                                                       │   │
│  │  [ON/OFF] 이탈 방지                    [설정 >]      │   │
│  │  평균 방문 주기의 1.5배 경과 시 자동 쿠폰 발송         │   │
│  │  이번 달: 12건 발송, 3명 재방문 (25%)                 │   │
│  │                                                       │   │
│  │  [ON/OFF] 생일 축하                    [설정 >]      │   │
│  │  생일 3일 전 자동 축하 쿠폰 발송                       │   │
│  │  이번 달: 8건 발송, 5명 사용 (62%)                    │   │
│  │                                                       │   │
│  │  [ON/OFF] 기념일                       [설정 >]      │   │
│  │  기념일 7일 전 자동 쿠폰 발송                          │   │
│  │  이번 달: 3건 발송, 2명 사용 (67%)                    │   │
│  │                                                       │   │
│  │  [ON/OFF] 첫 방문 팔로업               [설정 >]       │   │
│  │  첫 방문 3일 후 감사 메시지 + 쿠폰                     │   │
│  │  이번 달: 15건 발송, 6명 재방문 (40%)                 │   │
│  │                                                       │   │
│  │  [ON/OFF] VIP 마일스톤 축하            [설정 >]       │   │
│  │  방문 10/20/30/50/100회 도달 시 축하                   │   │
│  │  이번 달: 5건 발송                                    │   │
│  │                                                       │   │
│  │  [ON/OFF] 장기 미방문 윈백             [설정 >]       │   │
│  │  90일+ 미방문 고객에게 강력 할인 쿠폰                   │   │
│  │  이번 달: 20건 발송, 2명 복귀 (10%)                   │   │
│  │                                                       │   │
│  │  [ON/OFF] 비수기 프로모션              [설정 >]       │   │
│  │  한산한 요일 전날 자동 혜택 메시지                      │   │
│  │  이번 달: 4회 발송 (화요일 대상)                       │   │
│  │                                                       │   │
│  └───────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 시나리오 상세 설정 화면: `/automation/[ruleId]`

```
┌─────────────────────────────────────────────────────────────┐
│  ← 이탈 방지 설정                                           │
│                                                             │
│  ┌─ 트리거 조건 ─────────────────────────────────────────┐  │
│  │  방문 주기 배수: [1.5]배 경과 시 발동                    │  │
│  │  (고객의 평균 방문 주기가 10일이면 15일 후 발동)         │  │
│  │                                                        │  │
│  │  최소 방문 횟수: [2]회 이상 고객만 대상                   │  │
│  │  (1회 방문 고객은 '첫 방문 팔로업'에서 처리)             │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─ 쿠폰 설정 ──────────────────────────────────────────┐  │
│  │  쿠폰 발급: [ON]                                       │  │
│  │  할인 유형: (●) 할인율 (%) ( ) 할인금액 (원)            │  │
│  │  할인 값: [10] %                                       │  │
│  │  유효기간: [14]일                                       │  │
│  │  네이버 플레이스 URL 포함: [ON]                          │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─ 메시지 설정 ─────────────────────────────────────────┐  │
│  │  발송 채널: (●) 알림톡 ( ) SMS                         │  │
│  │                                                        │  │
│  │  메시지 내용:                                           │  │
│  │  ┌──────────────────────────────────────────────────┐  │  │
│  │  │ {고객명}님, 요즘 안 오셨네요!                      │  │  │
│  │  │ {매장명}에서 다음 방문 시 사용 가능한               │  │  │
│  │  │ {할인내용} 쿠폰을 드려요.                          │  │  │
│  │  │                                                    │  │  │
│  │  │ 쿠폰 코드: {쿠폰코드}                              │  │  │
│  │  │ 유효기간: {유효기간}                                │  │  │
│  │  └──────────────────────────────────────────────────┘  │  │
│  │  사용 가능 변수: {고객명} {매장명} {할인내용}            │  │
│  │                  {쿠폰코드} {유효기간}                   │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─ 발송 제한 ──────────────────────────────────────────┐  │
│  │  쿨다운: 동일 고객 [30]일 내 재발송 금지                 │  │
│  │  월 최대 발송: [100]건 (비용 제한)                       │  │
│  │  발송 시간대: [10:00] ~ [20:00]                        │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─ 성과 미리보기 ──────────────────────────────────────┐  │
│  │  현재 대상 고객: 23명                                   │  │
│  │  예상 월 발송: ~35건                                    │  │
│  │  예상 월 비용: ~₩1,750                                 │  │
│  └────────────────────────────────────────────────────────┘  │
│                                                             │
│                           [테스트 발송]  [저장]              │
└─────────────────────────────────────────────────────────────┘
```

## 1.5 비즈니스 룰

1. **마케팅 동의 필수**: `consentMarketing = true`인 고객에게만 발송
2. **쿨다운 적용**: AutomationLog 기반으로 동일 시나리오 + 동일 고객에 대한 최근 발송 이력 체크
3. **월 비용 상한**: 점주가 설정한 월 최대 발송 건수 초과 시 자동 중단
4. **지갑 잔액 체크**: 잔액 부족 시 발송 중단 + 점주에게 LOW_BALANCE 알림톡 발송
5. **발송 시간대 제한**: 밤 9시~오전 8시 발송 금지 (광고성 메시지 법적 제한)
6. **무료 크레딧 연동**: 월 30건 무료 크레딧을 자동화 메시지에도 적용
7. **중복 발송 방지**: 하나의 고객이 여러 시나리오에 동시 해당되더라도 1일 1건 제한 (우선순위: 생일 > 기념일 > 이탈방지 > 첫방문 > VIP > 윈백 > 비수기)

## 1.6 데이터 모델

```prisma
enum AutomationRuleType {
  CHURN_PREVENTION    // 이탈 방지
  BIRTHDAY            // 생일 축하
  ANNIVERSARY         // 기념일
  FIRST_VISIT_FOLLOWUP // 첫 방문 팔로업
  VIP_MILESTONE       // VIP 마일스톤
  WINBACK             // 장기 미방문 윈백
  SLOW_DAY_BOOST      // 비수기 프로모션
}

enum AutomationActionType {
  ALIMTALK
  SMS
}

model AutomationRule {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id])

  type      AutomationRuleType
  enabled   Boolean  @default(false)

  // 트리거 설정
  triggerConfig Json
  // CHURN_PREVENTION: { visitCycleMultiplier: 1.5, minVisitCount: 2 }
  // BIRTHDAY: { daysBefore: 3 }
  // ANNIVERSARY: { daysBefore: 7, surveyQuestionId: "xxx" }
  // FIRST_VISIT_FOLLOWUP: { daysAfter: 3 }
  // VIP_MILESTONE: { milestones: [10, 20, 30, 50, 100] }
  // WINBACK: { daysInactive: 90 }
  // SLOW_DAY_BOOST: { autoDetect: true, targetDayOfWeek: null }

  // 메시지 설정
  actionType      AutomationActionType @default(ALIMTALK)
  messageTemplate String  // 변수 포함 메시지 텍스트

  // 쿠폰 설정
  couponEnabled    Boolean @default(true)
  couponDiscountType String? // "PERCENT" | "FIXED"
  couponDiscountValue Int?   // 10 (%) 또는 3000 (원)
  couponValidDays  Int?     @default(14)
  includeNaverUrl  Boolean  @default(true)

  // 발송 제한
  cooldownDays     Int     @default(30)
  monthlyMaxSends  Int?    // null = 제한 없음
  sendTimeStart    String  @default("10:00")
  sendTimeEnd      String  @default("20:00")

  // 우선순위 (낮을수록 높은 우선순위)
  priority         Int     @default(50)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs AutomationLog[]

  @@unique([storeId, type])
}

model AutomationLog {
  id               String   @id @default(cuid())
  automationRuleId String
  rule             AutomationRule @relation(fields: [automationRuleId], references: [id])
  storeId          String
  customerId       String
  customer         Customer @relation(fields: [customerId], references: [id])

  // 발송 정보
  sentAt           DateTime @default(now())
  actionType       AutomationActionType
  alimtalkOutboxId String?  // AlimTalkOutbox 참조

  // 쿠폰 정보
  couponId         String?  // RetargetCoupon 참조
  couponCode       String?

  // 결과 추적 (ROI)
  couponUsed       Boolean  @default(false)
  couponUsedAt     DateTime?
  resultOrderId    String?  // 쿠폰 사용 시 주문 ID
  resultAmount     Int?     // 쿠폰 사용 시 결제 금액

  createdAt        DateTime @default(now())

  @@index([automationRuleId, customerId, sentAt])
  @@index([storeId, sentAt])
  @@index([couponCode])
}
```

## 1.7 핵심 지표 (KPI)

| 지표 | 산식 | 목표 |
|------|------|------|
| 자동 발송 건수 | 월별 AutomationLog 건수 | 매장당 월 30건+ |
| 쿠폰 사용률 | 쿠폰 사용 건수 / 발송 건수 × 100 | 20%+ |
| 재방문 전환율 | 발송 후 14일 내 방문한 고객 / 발송 고객 × 100 | 15%+ |
| 추정 추가 매출 | 쿠폰 사용 시 결제 금액 합계 | 매장당 월 100만원+ |
| 자동화 활성화율 | 자동화 1개+ ON인 매장 / 전체 매장 × 100 | 60%+ |

---

# 2. 고객 세그먼트 자동 분류

## 2.1 문제 정의

현재 고객 인사이트 페이지(`/insights/customers`)에서 성별, 연령대, 방문 경로 등 기본 통계를 제공하지만, **고객을 가치 기반으로 자동 분류하는 기능이 없다.** 점주는 "누가 VIP인지", "누가 이탈 위험인지" 한눈에 알 수 없다.

## 2.2 목표

> **"모든 고객을 자동으로 VIP/단골/성장가능/신규/이탈위험/이탈 6개 세그먼트로 분류하고, 세그먼트별 현황과 추이를 대시보드에 보여준다"**

## 2.3 세그먼트 정의

### RFM 기반 세그먼트

| 세그먼트 | R (Recency) | F (Frequency) | M (Monetary) | 설명 |
|---------|------------|---------------|-------------|------|
| **VIP** | 30일 이내 | 10회+ | 상위 20% | 핵심 고객, 매출의 주축 |
| **단골 (Regular)** | 45일 이내 | 5~9회 | 상위 50% | 안정적 재방문 고객 |
| **성장 가능 (Growing)** | 30일 이내 | 2~4회 | - | 단골로 성장 가능한 고객 |
| **신규 (New)** | 30일 이내 | 1회 | - | 첫 방문 고객 |
| **이탈 위험 (At-Risk)** | 45~90일 | 2회+ | - | 재방문 주기 이탈 |
| **이탈 (Churned)** | 90일+ | - | - | 장기 미방문 |

### 세그먼트 계산 로직

```
1. Recency = 현재일 - Customer.lastVisitAt (일수)
2. Frequency = Customer.visitCount
3. Monetary = SUM(VisitOrOrder.totalAmount) 최근 90일 기준
   (totalAmount가 없는 경우 SUM(PointLedger.delta WHERE type=EARN) 대용)

분류 우선순위:
  IF Recency > 90 → CHURNED
  IF Recency > 45 AND Frequency >= 2 → AT_RISK
  IF Frequency == 1 AND Recency <= 30 → NEW
  IF Frequency >= 10 AND Recency <= 30 AND Monetary 상위 20% → VIP
  IF Frequency >= 5 AND Recency <= 45 → REGULAR
  IF Frequency >= 2 AND Recency <= 30 → GROWING
  ELSE → NEW (fallback)
```

## 2.4 점주 화면 (UI 사양)

### 세그먼트 현황 페이지: `/segments`

```
┌─────────────────────────────────────────────────────────────┐
│  고객 세그먼트                                   [새로고침]   │
│                                                             │
│  ┌─ 세그먼트 요약 카드 (6개 가로 배열) ─────────────────┐   │
│  │ ⭐ VIP    │ 💚 단골    │ 📈 성장가능  │               │   │
│  │ 12명     │ 34명      │ 56명        │               │   │
│  │ ▲2 (↑)  │ ▼1 (↓)   │ ▲8 (↑)     │               │   │
│  │          │           │             │               │   │
│  │ 🆕 신규   │ ⚠️ 이탈위험 │ 💤 이탈     │               │   │
│  │ 28명     │ 15명      │ 45명        │               │   │
│  │ ▲5 (↑)  │ ▼3 (↓)   │ ▲2 (↑)     │               │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 세그먼트 분포 도넛 차트 ────────────────────────────┐   │
│  │                                                       │   │
│  │        [도넛 차트: 각 세그먼트 비율]                    │   │
│  │        총 고객: 190명                                  │   │
│  │                                                       │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 세그먼트 이동 추이 (30일) ──────────────────────────┐   │
│  │                                                       │   │
│  │  [스택 에리어 차트: 날짜별 세그먼트별 고객 수]          │   │
│  │                                                       │   │
│  │  주요 변화:                                            │   │
│  │  • VIP 2명 증가 (성장가능 → VIP 전환 3명)              │   │
│  │  • 이탈 위험 3명 감소 (재방문 유도 성공)                │   │
│  │  • 신규 5명 유입                                       │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 세그먼트별 상세 ─────────────────────────────────────┐  │
│  │ [VIP] [단골] [성장가능] [신규] [⚠️ 이탈위험] [💤 이탈]  │  │
│  │                                                        │  │
│  │ 이탈 위험 고객 (15명)                                   │  │
│  │ ┌──────────────────────────────────────────────────┐   │  │
│  │ │ 이름     마지막방문  방문횟수  평균주기  초과일수   │   │  │
│  │ │ 김OO    52일 전     8회      12일     +22일    │   │  │
│  │ │ 박OO    48일 전     5회      15일     +18일    │   │  │
│  │ │ ...                                             │   │  │
│  │ └──────────────────────────────────────────────────┘   │  │
│  │                                                        │  │
│  │  [이 세그먼트에 메시지 보내기] [자동화 설정으로 이동]     │  │
│  └────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 2.5 데이터 모델

```prisma
enum CustomerSegment {
  VIP
  REGULAR
  GROWING
  NEW
  AT_RISK
  CHURNED
}

// Customer 모델에 추가할 필드
// segment           CustomerSegment?
// avgVisitCycleDays Int?           // 평균 방문 주기 (일)
// totalSpent        Int?           // 누적 소비 금액 (90일)
// lastSegmentedAt   DateTime?      // 마지막 세그먼트 계산일

// 세그먼트 변화 추적 (일별 스냅샷)
model SegmentSnapshot {
  id        String   @id @default(cuid())
  storeId   String
  date      DateTime @db.Date

  vipCount      Int @default(0)
  regularCount  Int @default(0)
  growingCount  Int @default(0)
  newCount      Int @default(0)
  atRiskCount   Int @default(0)
  churnedCount  Int @default(0)

  createdAt DateTime @default(now())

  @@unique([storeId, date])
}
```

## 2.6 자동화 엔진과의 연동

세그먼트는 자동화 엔진의 **입력 데이터**로 활용된다:

- **AT_RISK 세그먼트** → 시나리오 A (이탈 방지) 자동 발동
- **CHURNED 세그먼트** → 시나리오 F (윈백) 자동 발동
- **NEW 세그먼트** → 시나리오 D (첫 방문 팔로업) 대상
- **VIP 세그먼트** → 시나리오 E (VIP 마일스톤) 대상

또한 기존 SMS/브랜드 메시지 캠페인의 **타겟 선택**에 세그먼트 필터를 추가한다:
- 현재 타겟: ALL, REVISIT, NEW, CUSTOM
- 추가: VIP, REGULAR, GROWING, AT_RISK, CHURNED

## 2.7 핵심 지표 (KPI)

| 지표 | 산식 | 의미 |
|------|------|------|
| VIP 비율 | VIP / 전체 × 100 | 매장 핵심 고객 비중 |
| 이탈 위험 비율 | AT_RISK / 전체 × 100 | 관리 필요 수준 |
| 세그먼트 상향 이동률 | 상위 세그먼트 이동 고객 / 전체 × 100 | CRM 효과 |
| 이탈 방지 성공률 | AT_RISK → REGULAR/VIP 전환 / AT_RISK × 100 | 자동화 효과 |

---

# 3. 생일/기념일 자동 마케팅

## 3.1 문제 정의

현재 `Customer.birthday` 필드와 `SurveyQuestion (type: DATE)` + `SurveyAnswer (valueDate)` 로 기념일 데이터를 수집하고 있지만, **이 데이터를 활용한 자동 마케팅 기능이 전혀 없다.** 수집만 하고 활용하지 않는 상태.

## 3.2 목표

> **"고객의 생일과 기념일에 맞춰 자동으로 축하 메시지 + 쿠폰을 발송하여 방문을 유도한다"**

## 3.3 상세 시나리오

### 생일 마케팅 플로우

```
[데이터 수집]
  └─ Customer.birthday (MM-DD 형식)
       └─ 포인트 적립 시 입력
       └─ 카카오 연동 시 자동 수집

[자동화 플로우]
  └─ 매일 오전 9시 배치 실행
       └─ "오늘로부터 D일 후가 생일인 고객" 조회 (D = triggerConfig.daysBefore)
            └─ 마케팅 동의 확인
            └─ 올해 이미 생일 쿠폰 발송했는지 확인 (쿨다운)
            └─ 쿠폰 생성 (RetargetCoupon)
                 └─ 유효기간: 생일 전후 7일
                 └─ 할인: 점주 설정값
            └─ 알림톡 발송
                 └─ "{고객명}님, 생일 축하드려요! {매장명}에서 특별한 쿠폰을 드려요"
                 └─ 쿠폰 내용 + 코드 + 유효기간 포함

[결과 추적]
  └─ AutomationLog에 기록
  └─ 쿠폰 사용 시 couponUsed = true, resultAmount 기록
```

### 기념일 마케팅 플로우

```
[데이터 수집]
  └─ SurveyQuestion (type: DATE, label: "기념일")
       └─ SurveyAnswer.valueDate (YYYY-MM-DD)
       └─ 포인트 적립 시 설문으로 수집

[자동화 플로우]
  └─ 매일 오전 9시 배치 실행
       └─ "오늘로부터 D일 후가 기념일인 고객" 조회
            └─ SurveyAnswer JOIN SurveyQuestion WHERE type=DATE
            └─ 연도 무시, 월-일 기준 비교
       └─ 쿠폰 생성 + 알림톡 발송
            └─ "{고객명}님, 소중한 기념일이 다가오고 있어요"
            └─ "특별한 날, {매장명}이 함께합니다"

[결과 추적]
  └─ 동일하게 AutomationLog 기록
```

## 3.4 점주 설정 화면

기능 1(자동화 엔진)의 시나리오별 설정 화면과 동일한 패턴을 따른다.

**생일 전용 추가 설정:**
- 발송 시점: D-[1~7]일 전 (기본: D-3)
- 쿠폰 유효기간: 생일 전후 [1~14]일 (기본: 7일)
- 메시지 템플릿 커스터마이징

**기념일 전용 추가 설정:**
- 기념일 설문 질문 선택 (SurveyQuestion 중 type=DATE인 질문)
- 발송 시점: D-[1~14]일 전 (기본: D-7)
- 쿠폰 유효기간: 기념일 전후 [1~14]일 (기본: 7일)

## 3.5 엣지 케이스

| 케이스 | 처리 방법 |
|--------|---------|
| 생일이 2월 29일 | 윤년이 아닌 해에는 2월 28일에 발송 |
| 기념일을 여러 개 등록한 경우 | 설문 질문별로 각각 자동화 규칙 생성 가능 |
| 생일 정보 없는 고객 | 대상에서 제외 (포인트 적립 시 생일 입력 유도 메시지 추가 고려) |
| 올해 이미 발송한 고객 | AutomationLog에서 해당 연도 발송 이력 확인 → 스킵 |
| 가입 당일이 생일인 경우 | 가입 후 최소 1일 경과 후 발송 (첫 방문 팔로업과 중복 방지) |

## 3.6 기대 효과

| 지표 | 기대값 | 근거 |
|------|-------|------|
| 생일 쿠폰 사용률 | 30~40% | 업계 평균 생일 쿠폰 사용률 |
| 기념일 쿠폰 사용률 | 25~35% | 기념일은 외식 니즈가 높음 |
| 동반 방문 효과 | 객단가 1.5~2배 | 생일/기념일은 2인+ 방문 |
| 고객 충성도 | NPS +15~20점 | "이 가게가 내 특별한 날을 기억해준다" |

---

# 4. 재방문 주기 분석 + 스마트 넛지

## 4.1 문제 정의

현재 이탈 방지는 고정된 일수(예: 90일)로만 판단할 수 있다. 하지만 **고객마다 방문 패턴이 다르다.** 매주 오는 고객이 2주만 안 와도 이상 신호이고, 한 달에 한 번 오는 고객이 2주 안 온 것은 정상이다.

## 4.2 목표

> **"고객별 고유한 방문 주기를 학습하고, 최적의 타이밍에 개인화된 메시지를 보내 재방문을 유도한다"**

## 4.3 방문 주기 계산 로직

```
[데이터 소스]
  └─ VisitOrOrder.visitedAt (방문 기록)
  └─ PointLedger WHERE type=EARN (포인트 적립 기록)

[계산 방법]
  1. 고객의 모든 방문 일시를 시간순 정렬
  2. 연속된 방문 간 간격(일수) 계산
     visits = [1/1, 1/8, 1/20, 2/3, 2/15]
     gaps = [7, 12, 14, 12]
  3. 이상치 제거: 상위/하위 10% 제거 (예: 1일 차이의 중복 방문, 180일 공백)
  4. 평균 방문 주기 = MEAN(gaps)
     예: (7 + 12 + 14 + 12) / 4 = 11.25일 → 11일
  5. 최소 방문 3회 이상인 고객만 계산 (데이터 충분성)

[저장]
  └─ Customer.avgVisitCycleDays = 11
  └─ 매일 배치로 재계산
```

## 4.4 스마트 넛지 타이밍

고객의 평균 방문 주기(avgVisitCycleDays)를 기준으로 3단계 넛지:

```
[1단계: 가벼운 리마인드]
  타이밍: avgVisitCycleDays × 1.0 경과 시
  메시지: 부드러운 리마인드 (쿠폰 없음)
  예시: "OO님, {최근 주문 메뉴} 맛있으셨나요? 오늘도 맛있는 하루 되세요 😊"
  비용: 알림톡 20원
  → 아직 이탈이 아닌 자연스러운 리마인드

[2단계: 쿠폰 유도]
  타이밍: avgVisitCycleDays × 1.5 경과 시
  메시지: 재방문 쿠폰 포함
  예시: "OO님, {매장명}에서 다시 뵙고 싶어요! {할인내용} 쿠폰을 드려요"
  비용: 알림톡 50원 (쿠폰 포함)
  → 자동화 엔진의 CHURN_PREVENTION 시나리오와 연동

[3단계: 최종 윈백]
  타이밍: avgVisitCycleDays × 3.0 경과 시 (또는 90일)
  메시지: 강력한 할인 쿠폰
  예시: "OO님, 정말 오랜만이에요. 특별한 쿠폰을 준비했어요"
  비용: 알림톡 50원 (쿠폰 포함)
  → 자동화 엔진의 WINBACK 시나리오와 연동
```

## 4.5 메시지 개인화

현재 `VisitOrOrder.items` (JSON)에 주문 내역이 저장되어 있으므로, 메시지에 개인화 요소를 추가할 수 있다:

| 변수 | 소스 | 예시 |
|------|------|------|
| `{고객명}` | Customer.name | "김민수" |
| `{최근메뉴}` | 최근 VisitOrOrder.items에서 첫 번째 아이템 | "부대찌개" |
| `{방문횟수}` | Customer.visitCount | "15" |
| `{마지막방문}` | Customer.lastVisitAt | "2주 전" |
| `{매장명}` | Store.name | "맛있는 식당" |

## 4.6 점주 화면 (UI 사양)

### 인사이트 > 방문 주기 분석: `/insights/visit-cycle`

```
┌─────────────────────────────────────────────────────────────┐
│  방문 주기 분석                                               │
│                                                             │
│  ┌─ 핵심 지표 ──────────────────────────────────────────┐   │
│  │  매장 평균 방문 주기     방문 주기 분석 가능 고객          │   │
│  │      14.2일                  89명 / 190명             │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 방문 주기 분포 (히스토그램) ─────────────────────────┐   │
│  │                                                       │   │
│  │  █                                                    │   │
│  │  ██                                                   │   │
│  │  ████                                                 │   │
│  │  ██████                                               │   │
│  │  ████████                                             │   │
│  │  ██████                                               │   │
│  │  ████                                                 │   │
│  │  ──────────────────────────────────                   │   │
│  │  3일  7일  14일  21일  30일  45일+                     │   │
│  │                                                       │   │
│  │  가장 많은 고객의 방문 주기: 7~14일 (42명)              │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 넛지 대상 현황 ─────────────────────────────────────┐   │
│  │                                                       │   │
│  │  1단계 (리마인드 대상): 12명                           │   │
│  │  2단계 (쿠폰 유도 대상): 8명                           │   │
│  │  3단계 (윈백 대상): 23명                               │   │
│  │                                                       │   │
│  │  [자동 넛지 설정으로 이동 →]                            │   │
│  └───────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

## 4.7 데이터 모델 변경

```prisma
// Customer 모델에 추가
// avgVisitCycleDays  Int?      // 평균 방문 주기 (일수)
// visitCycleStdDev   Float?    // 방문 주기 표준편차 (규칙성 지표)
// lastMenuItems      Json?     // 최근 주문 메뉴 (개인화용 캐시)
```

## 4.8 핵심 지표 (KPI)

| 지표 | 산식 | 목표 |
|------|------|------|
| 1단계 넛지 후 방문률 | 1단계 발송 후 7일 내 방문 / 발송 × 100 | 30%+ |
| 2단계 쿠폰 사용률 | 쿠폰 사용 / 발송 × 100 | 20%+ |
| 평균 방문 주기 단축 | 자동화 전 vs 후 평균 주기 비교 | -10%+ |

---

# 5. 추천인 프로그램

## 5.1 문제 정의

현재 신규 고객 획득은 외부 마케팅(local-customers SMS)에 의존하고 있다. **기존 고객의 입소문을 체계적으로 활용하는 시스템이 없다.** 추천으로 온 고객은 일반 고객 대비 LTV가 16~25% 높다는 연구 결과가 있다.

## 5.2 목표

> **"기존 고객에게 추천 코드를 발급하고, 추천으로 유입된 신규 고객과 추천인 모두에게 보상하여 자연스러운 고객 확장을 만든다"**

## 5.3 추천 플로우

```
[추천인 측]
  1. 포인트/스탬프 적립 후 완료 화면에서 추천 코드 노출
     "친구에게 추천하고 포인트 받으세요! 내 추천 코드: ABCD1234"
  2. 카카오톡 공유 버튼 → 추천 링크 전송
     "{매장명}에서 맛있는 거 먹었는데, 이 코드로 가면 할인 받아! → ABCD1234"
  3. 추천 성공 시 → 알림톡: "OO님이 추천으로 방문했어요! 감사 포인트 {N}P 적립"

[피추천인 측]
  1. 첫 포인트 적립 시 "추천 코드가 있으신가요?" 입력란
     또는 추천 링크로 직접 접속
  2. 추천 코드 입력 → 첫 방문 할인 쿠폰 즉시 발급
  3. 적립 완료 화면: "추천인 {이름}님 덕분에 할인 쿠폰을 받았어요!"

[매장 측]
  추천 대시보드에서 추천 현황 확인:
  - 이번 달 추천 신규: N명
  - 활성 추천인: N명
  - 추천 고객 재방문율: N%
```

## 5.4 보상 구조

| 이벤트 | 추천인 보상 | 피추천인 보상 |
|--------|-----------|-------------|
| 피추천인 첫 방문 | 포인트 +1,000P | 첫 방문 10% 할인 쿠폰 |
| 피추천인 3회 방문 (보너스) | 포인트 +2,000P | - |
| 피추천인 5회 방문 (보너스) | 포인트 +3,000P | - |

**보상 설정은 점주가 커스터마이징 가능:**
- 추천인 보상: 포인트 또는 쿠폰 (금액/할인율 설정)
- 피추천인 보상: 쿠폰 (할인율/할인금액 설정)
- 보너스 마일스톤: ON/OFF + 횟수 + 금액

## 5.5 점주 화면 (UI 사양)

### 추천 프로그램 설정: `/referral`

```
┌─────────────────────────────────────────────────────────────┐
│  추천 프로그램                              [ON/OFF 토글]     │
│                                                             │
│  ┌─ 현황 요약 ──────────────────────────────────────────┐   │
│  │  이번 달 추천       추천 전환        추천 고객 매출       │   │
│  │    12명             8명 (67%)        ₩480,000         │   │
│  │                                                       │   │
│  │  누적 추천: 89명    활성 추천인: 23명                   │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 보상 설정 ──────────────────────────────────────────┐   │
│  │                                                       │   │
│  │  추천인 보상:                                          │   │
│  │    유형: (●) 포인트 ( ) 쿠폰                          │   │
│  │    금액: [1,000] P                                    │   │
│  │                                                       │   │
│  │  피추천인 보상:                                        │   │
│  │    유형: 할인 쿠폰                                     │   │
│  │    할인: [10] % (첫 방문 시)                           │   │
│  │    유효기간: [30]일                                    │   │
│  │                                                       │   │
│  │  보너스 마일스톤: [ON]                                  │   │
│  │    3회 방문 시: 추천인 +[2,000]P                       │   │
│  │    5회 방문 시: 추천인 +[3,000]P                       │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 추천 랭킹 (Top 추천인) ─────────────────────────────┐   │
│  │  1. 김OO  - 8명 추천, 총 보상 ₩24,000P               │   │
│  │  2. 박OO  - 5명 추천, 총 보상 ₩15,000P               │   │
│  │  3. 이OO  - 4명 추천, 총 보상 ₩12,000P               │   │
│  └──────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 추천 내역 ──────────────────────────────────────────┐   │
│  │  날짜       추천인    피추천인    상태     보상         │   │
│  │  2/8       김OO     이OO      3회방문   +2,000P     │   │
│  │  2/7       박OO     최OO      첫방문    +1,000P     │   │
│  │  2/5       김OO     정OO      쿠폰사용  할인 적용     │   │
│  │  ...                                                  │   │
│  └──────────────────────────────────────────────────────┘   │
└─────────────────────────────────────────────────────────────┘
```

### 고객 화면: 포인트 적립 완료 후

```
┌─────────────────────────────────────────────────────────────┐
│                                                             │
│  ✅ 500P 적립 완료!                                         │
│  총 보유 포인트: 3,500P                                      │
│                                                             │
│  ─────────────────────────────────────────                  │
│                                                             │
│  📣 친구 추천하고 1,000P 받으세요!                            │
│                                                             │
│  내 추천 코드                                                │
│  ┌──────────────────────────────────┐                       │
│  │       ABCD1234                   │  [복사]               │
│  └──────────────────────────────────┘                       │
│                                                             │
│  [카카오톡으로 공유하기]                                       │
│                                                             │
│  추천한 친구: 3명                                             │
│  받은 보상: 총 6,000P                                        │
│                                                             │
└─────────────────────────────────────────────────────────────┘
```

## 5.6 데이터 모델

```prisma
model ReferralSetting {
  id                String @id @default(cuid())
  storeId           String @unique
  store             Store  @relation(fields: [storeId], references: [id])

  enabled           Boolean @default(false)

  // 추천인 보상
  referrerRewardType String @default("POINT") // "POINT" | "COUPON"
  referrerRewardValue Int   @default(1000)     // 포인트 금액 또는 쿠폰 할인값

  // 피추천인 보상
  refereeDiscountType String @default("PERCENT") // "PERCENT" | "FIXED"
  refereeDiscountValue Int   @default(10)         // 10% 또는 3000원
  refereeDiscountValidDays Int @default(30)

  // 보너스 마일스톤
  bonusEnabled      Boolean @default(false)
  bonusMilestones   Json?   // [{ visitCount: 3, rewardValue: 2000 }, { visitCount: 5, rewardValue: 3000 }]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Referral {
  id             String   @id @default(cuid())
  storeId        String

  referrerId     String   // 추천인 Customer ID
  referrer       Customer @relation("referrer", fields: [referrerId], references: [id])

  refereeId      String   // 피추천인 Customer ID
  referee        Customer @relation("referee", fields: [refereeId], references: [id])

  // 상태 추적
  status         String   @default("SIGNED_UP") // SIGNED_UP, FIRST_VISIT, ACTIVE
  refereeVisitCount Int   @default(0)

  // 보상 이력
  totalReferrerReward Int @default(0)
  lastRewardAt       DateTime?

  // 쿠폰
  refereeCouponId    String? // RetargetCoupon ID
  refereeCouponUsed  Boolean @default(false)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, refereeId]) // 1명은 1번만 추천 받을 수 있음
  @@index([storeId, referrerId])
}

// Customer 모델에 추가
// referralCode   String?  @unique  // 고유 추천 코드 (6자리)
// referredBy     String?           // 추천인 Customer ID
```

## 5.7 추천 코드 생성 규칙

```
형식: 영문대문자 + 숫자 6자리
문자셋: 23456789ABCDEFGHJKLMNPQRSTUVWXYZ (기존 RetargetCoupon과 동일, 혼동 문자 제외)
예시: A3X7K2
생성 시점: 고객 첫 포인트 적립 시 자동 생성
유일성: Customer.referralCode UNIQUE 제약
```

## 5.8 핵심 지표 (KPI)

| 지표 | 산식 | 목표 |
|------|------|------|
| 추천 전환율 | 추천 코드 입력 고객 / 전체 신규 × 100 | 10%+ |
| 추천 고객 재방문율 | 추천 고객 중 2회+ 방문 / 전체 추천 고객 × 100 | 50%+ |
| 활성 추천인 비율 | 1명+ 추천 성공 고객 / 전체 고객 × 100 | 5%+ |
| 추천 고객 LTV 대비 | 추천 고객 평균 LTV / 일반 고객 평균 LTV | 1.2배+ |
| 추천 CAC | 추천인 보상 총액 / 추천 신규 고객 수 | < SMS CAC |

---

# 6. 매출 기여 대시보드

## 6.1 문제 정의

점주가 CRM을 사용하면서 **"이게 실제로 매출에 도움이 되는 건가?"**라는 질문에 답할 수 있는 화면이 없다. CRM의 가치를 수치로 증명하지 못하면 해지율이 높아진다.

## 6.2 목표

> **"CRM이 만들어낸 추가 매출을 명확한 숫자로 보여주어, 점주가 CRM의 ROI를 직접 체감할 수 있게 한다"**

## 6.3 매출 기여 추적 방법

### 추적 가능한 매출 기여 채널

| 채널 | 추적 방법 | 데이터 소스 |
|------|---------|-----------|
| **자동화 쿠폰** | 자동화 발송 쿠폰 사용 시 결제 금액 | AutomationLog.resultAmount |
| **수동 캠페인** | 리타겟 쿠폰 사용 시 결제 금액 | RetargetCoupon.usedAt + VisitOrOrder |
| **추천 프로그램** | 추천 고객의 누적 매출 | Referral.refereeId → VisitOrOrder.totalAmount |
| **이탈 방지** | AT_RISK → 재방문 시 매출 | AutomationLog(CHURN_PREVENTION).resultAmount |
| **윈백** | CHURNED → 재방문 시 매출 | AutomationLog(WINBACK).resultAmount |
| **생일/기념일** | 쿠폰 사용 시 매출 | AutomationLog(BIRTHDAY/ANNIVERSARY).resultAmount |

### 매출 기여 계산 공식

```
[CRM 추가 매출] =
  자동화 쿠폰 사용 매출
  + 수동 캠페인 쿠폰 사용 매출
  + 추천 고객 매출
  + (선택) 이탈 방지 재방문 매출

[CRM ROI] =
  CRM 추가 매출 / (구독료 + 메시지 비용 + 쿠폰 할인 비용) × 100

[고객당 CRM 가치] =
  CRM 추가 매출 / 활성 고객 수
```

## 6.4 점주 화면 (UI 사양)

### 매출 기여 대시보드: `/insights/revenue`

```
┌─────────────────────────────────────────────────────────────┐
│  매출 기여 분석                     기간: [이번 달 ▼]         │
│                                                             │
│  ┌─ 핵심 지표 카드 (4열) ────────────────────────────────┐  │
│  │ CRM 추가 매출   │ CRM ROI    │ 쿠폰 사용률 │ 활성 고객  │  │
│  │ ₩2,340,000    │ 780%       │ 24.5%      │ 145명    │  │
│  │ ▲15% vs 전월   │ ▲120% 전월  │ ▲3.2% 전월  │ ▲12명   │  │
│  └───────────────────────────────────────────────────────┘  │
│                                                             │
│  ┌─ 채널별 매출 기여 (가로 막대 차트) ───────────────────┐   │
│  │                                                       │   │
│  │  자동화 - 이탈방지    ████████████████  ₩890,000       │   │
│  │  자동화 - 생일/기념일  █████████████    ₩720,000       │   │
│  │  수동 캠페인          ████████         ₩430,000       │   │
│  │  추천 프로그램        ███████          ₩300,000       │   │
│  │                                                       │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 매출 추이 (월별 라인 차트) ──────────────────────────┐   │
│  │                                                       │   │
│  │  [라인 차트: 월별 CRM 추가 매출 추이]                   │   │
│  │                                                       │   │
│  │  9월: ₩1.2M  10월: ₩1.5M  11월: ₩1.8M  12월: ₩2.3M  │   │
│  │                                                       │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 세그먼트별 매출 (도넛 차트 + 테이블) ────────────────┐   │
│  │                                                       │   │
│  │  [도넛 차트]          VIP (12명): ₩4,200,000 (45%)    │   │
│  │                      단골 (34명): ₩2,800,000 (30%)   │   │
│  │                      성장 (56명): ₩1,500,000 (16%)   │   │
│  │                      신규 (28명): ₩600,000 (6%)      │   │
│  │                      복귀 (5명):  ₩300,000 (3%)      │   │
│  │                                                       │   │
│  │  인사이트: VIP 12명(6%)이 전체 매출의 45%를 차지합니다.  │   │
│  │  → VIP 유지가 매출 안정성의 핵심입니다.                  │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ 비용 대비 효과 ─────────────────────────────────────┐   │
│  │                                                       │   │
│  │  항목              비용          매출 기여    ROI       │   │
│  │  자동화 메시지      ₩47,500      ₩1,610,000  33.9x    │   │
│  │  수동 캠페인        ₩25,000      ₩430,000    17.2x    │   │
│  │  추천인 보상        ₩89,000      ₩300,000    3.4x     │   │
│  │  ──────────────────────────────────────────────────   │   │
│  │  합계              ₩161,500     ₩2,340,000   14.5x   │   │
│  │                                                       │   │
│  │  💡 CRM에 ₩1 투자할 때마다 ₩14.5의 매출이 발생합니다    │   │
│  └───────────────────────────────────────────────────────┘   │
│                                                             │
│  ┌─ AI 인사이트 (자동 생성) ─────────────────────────────┐  │
│  │                                                        │  │
│  │  📊 이번 달 주요 발견:                                   │  │
│  │  • 생일 쿠폰 사용률이 38%로 가장 높습니다                 │  │
│  │  • 이탈 방지 자동화로 8명이 재방문했습니다 (₩890K 매출)    │  │
│  │  • 화요일 비수기 프로모션이 매출 22% 증가 효과             │  │
│  │  • VIP 고객 김OO님이 3명을 추천하여 ₩150K 매출 기여       │  │
│  │                                                        │  │
│  │  💡 추천:                                               │  │
│  │  • 이탈 위험 고객 15명에게 쿠폰 할인율을 15%로 올려보세요  │  │
│  │  • 기념일 데이터가 있는 고객이 12명뿐입니다.               │  │
│  │    설문에서 기념일을 더 적극적으로 수집하세요              │  │
│  └────────────────────────────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
```

## 6.5 홈 대시보드 위젯

기존 `/home` 대시보드에 간략한 매출 기여 위젯을 추가:

```
┌─ CRM 매출 기여 (이번 달) ──────────────────┐
│  추가 매출: ₩2,340,000                     │
│  ▲15% vs 전월                              │
│                                            │
│  쿠폰 23건 사용 │ 재방문 유도 8명            │
│                                            │
│  [상세 보기 →]                              │
└────────────────────────────────────────────┘
```

## 6.6 데이터 모델

```prisma
// 월별 매출 기여 스냅샷 (일별 배치로 업데이트)
model RevenueAttribution {
  id        String   @id @default(cuid())
  storeId   String
  yearMonth String   // "2026-02"

  // 채널별 매출
  automationChurnRevenue    Int @default(0)  // 이탈방지 자동화 매출
  automationBirthdayRevenue Int @default(0)  // 생일 자동화 매출
  automationAnnivRevenue    Int @default(0)  // 기념일 자동화 매출
  automationFirstVisitRevenue Int @default(0) // 첫방문 팔로업 매출
  automationVipRevenue      Int @default(0)  // VIP 마일스톤 매출
  automationWinbackRevenue  Int @default(0)  // 윈백 매출
  automationSlowDayRevenue  Int @default(0)  // 비수기 매출
  manualCampaignRevenue     Int @default(0)  // 수동 캠페인 매출
  referralRevenue           Int @default(0)  // 추천 프로그램 매출

  // 비용
  automationCost    Int @default(0)  // 자동화 메시지 비용
  campaignCost      Int @default(0)  // 수동 캠페인 비용
  referralCost      Int @default(0)  // 추천인 보상 비용 (포인트)

  // 활동 지표
  couponsSent       Int @default(0)
  couponsUsed       Int @default(0)
  customersReturned Int @default(0)  // 자동화로 재방문한 고객
  referralsCount    Int @default(0)  // 추천 신규 고객

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@unique([storeId, yearMonth])
}
```

## 6.7 핵심 지표 (KPI)

| 지표 | 산식 | 의미 |
|------|------|------|
| CRM 추가 매출 | 모든 채널 매출 합계 | CRM의 직접적 매출 기여 |
| CRM ROI | 추가 매출 / (메시지 비용 + 쿠폰 비용) × 100 | 투자 대비 효과 |
| 쿠폰 사용률 | 사용 쿠폰 / 발송 쿠폰 × 100 | 마케팅 효과성 |
| 고객당 CRM 가치 | 추가 매출 / 활성 고객 수 | 고객 1명당 CRM 기여 |
| 매출 성장률 | 이번 달 / 전월 - 1 | CRM 효과 추이 |

---

# 구현 로드맵

## Phase 1 (2~3주): 기반 인프라

1. **DB 마이그레이션**: AutomationRule, AutomationLog, SegmentSnapshot, ReferralSetting, Referral, RevenueAttribution 모델 추가
2. **Customer 모델 확장**: segment, avgVisitCycleDays, totalSpent, referralCode 필드 추가
3. **세그먼트 계산 Worker**: 매일 배치로 전체 고객 RFM 계산 + 세그먼트 할당
4. **방문 주기 계산 Worker**: 매일 배치로 avgVisitCycleDays 계산

## Phase 2 (2~3주): 자동화 엔진 + 생일/기념일

5. **자동화 엔진 Worker**: 매 시간 실행, 활성화된 규칙의 조건 체크 + 발송
6. **자동화 설정 API**: CRUD + ON/OFF
7. **자동화 설정 UI**: `/automation` 메인 + `/automation/[ruleId]` 상세
8. **기존 RetargetCoupon + AlimTalkOutbox 연동**: 쿠폰 생성 + 알림톡 발송 재사용

## Phase 3 (1~2주): 추천인 프로그램

9. **추천 코드 생성 + 검증 API**
10. **추천 보상 처리 로직** (포인트 적립 시 추천인 체크)
11. **추천 설정 + 현황 UI**: `/referral`
12. **고객 화면 추천 코드 노출**: 적립 완료 화면에 추가

## Phase 4 (1~2주): 대시보드 + 인사이트

13. **세그먼트 현황 UI**: `/segments`
14. **방문 주기 분석 UI**: `/insights/visit-cycle`
15. **매출 기여 대시보드 API + UI**: `/insights/revenue`
16. **홈 대시보드 위젯 추가**: CRM 매출 기여 요약

## 사이드바 네비게이션 변경

```
현재:
  마케팅
    ├─ 메시지 발송
    ├─ 신규 고객 타겟
    └─ 네이버 리뷰 요청

변경:
  마케팅
    ├─ 🤖 자동 마케팅 (NEW)     ← 자동화 엔진
    ├─ 메시지 발송
    ├─ 신규 고객 타겟
    ├─ 추천인 마케팅 (NEW)       ← 추천인 시스템
    └─ 네이버 리뷰 요청

  인사이트
    ├─ 고객 통계
    ├─ 고객 세그먼트 (NEW)       ← RFM 세그먼트
    ├─ 방문 주기 분석 (NEW)      ← 스마트 넛지
    └─ 매출 기여 (NEW)          ← 매출 대시보드
```

---

# 수정 대상 파일 목록

| 파일 | 변경 내용 |
|-----|---------|
| `prisma/schema.prisma` | 새 모델 6개 + Customer 필드 확장 |
| `apps/api/src/routes/automation.ts` | 자동화 규칙 CRUD API (신규) |
| `apps/api/src/routes/segments.ts` | 세그먼트 조회 API (신규) |
| `apps/api/src/routes/referral.ts` | 추천 프로그램 API (신규) |
| `apps/api/src/routes/insights.ts` | 매출 기여 + 방문 주기 API 추가 |
| `apps/api/src/routes/dashboard.ts` | CRM 매출 요약 위젯 API 추가 |
| `apps/api/src/services/automation-worker.ts` | 자동화 실행 Worker (신규) |
| `apps/api/src/services/segment-worker.ts` | 세그먼트 계산 Worker (신규) |
| `apps/api/src/services/solapi.ts` | 새 AlimTalkType 추가 |
| `apps/api/src/index.ts` | 새 Worker 시작 + 새 라우트 등록 |
| `apps/web/src/app/(dashboard)/automation/` | 자동화 설정 페이지 (신규) |
| `apps/web/src/app/(dashboard)/segments/` | 세그먼트 현황 페이지 (신규) |
| `apps/web/src/app/(dashboard)/referral/` | 추천 프로그램 페이지 (신규) |
| `apps/web/src/app/(dashboard)/insights/revenue/` | 매출 기여 대시보드 (신규) |
| `apps/web/src/app/(dashboard)/insights/visit-cycle/` | 방문 주기 분석 (신규) |
| `apps/web/src/app/(dashboard)/home/page.tsx` | CRM 매출 위젯 추가 |
| `apps/web/src/components/layout/sidebar.tsx` | 새 메뉴 항목 추가 |
| `apps/web/src/app/enroll/` | 추천 코드 입력란 + 공유 버튼 추가 |

---

# TagHere 비즈니스 모델 영향

| 기능 | TagHere 수익 | 점주 수익 |
|------|------------|---------|
| 자동화 엔진 | 메시지 발송 과금 (20~50원/건) | 재방문 유도 → 매출 증가 |
| 세그먼트 | CRM 가치 체감 → 해지율 감소 | 고객 현황 가시성 |
| 생일/기념일 | 메시지 발송 과금 | 높은 전환율 + 높은 객단가 |
| 스마트 넛지 | 메시지 발송 과금 | 최적 타이밍 재방문 유도 |
| 추천 프로그램 | 신규 매장 유입 기회 | CAC 절감 + 높은 LTV 고객 |
| 매출 대시보드 | 프리미엄 플랜 업셀 근거 | ROI 증명 → 투자 확신 |
