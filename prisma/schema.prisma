// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// 매장
model Store {
  id                     String         @id @default(cuid())
  slug                   String?        @unique // URL 슬러그 (고객 등록 링크용)
  name                   String         // 상호명
  category               StoreCategory? // 업종
  ownerName              String?        // 대표자명
  phone                  String?        // 연락처
  businessRegNumber      String?        // 사업자등록번호
  address                String?        // 전체 주소 (하위 호환성 유지)

  // 정규화된 주소 필드
  addressSido            String?        // 시/도
  addressSigungu         String?        // 시/군/구
  addressDetail          String?        // 상세 주소

  naverPlaceId           String?        // 네이버 플레이스 ID (리뷰 연동용)
  naverPlaceUrl          String?  // 네이버 플레이스 공유 링크
  crmEnabled             Boolean  @default(true) // CRM 기능 활성화 여부 (태그히어 연동)
  pointsAlimtalkEnabled  Boolean  @default(true) // 포인트 적립/사용 알림톡 자동 발송
  pointsAlimtalkFrequency String  @default("EVERY_ORDER") // 알림톡 발송 빈도: "EVERY_ORDER" | "FIRST_ONLY"
  // 포인트 적립률 설정 (결제금액 기반) - 항상 활성화
  pointRatePercent       Float    @default(5)     // 적립률 (%) - 소수점 한 자리까지 지원 (0.1~99.9)
  // 포인트 사용 규칙
  pointUsageRule         String?  @db.Text        // 포인트 사용 규칙 안내 문구
  // 알림톡 지연 발송 설정
  alimtalkDelayEnabled   Boolean  @default(false) // 알림톡 지연 발송 ON/OFF (기본: 비활성화)
  alimtalkDelayMinutes   Int      @default(30)    // 지연 시간 (분, 10~120)
  createdAt              DateTime @default(now())
  updatedAt              DateTime @updatedAt

  // 프랜차이즈 연동
  franchiseId           String?
  franchise             Franchise? @relation(fields: [franchiseId], references: [id])
  franchiseStampEnabled Boolean    @default(false)  // 통합 스탬프 참여 여부

  // Relations
  staffUsers            StaffUser[]
  customers             Customer[]
  visitsOrOrders        VisitOrOrder[]
  pointLedger           PointLedger[]
  stampLedger           StampLedger[]
  stampSetting          StampSetting?
  pointPolicy           PointPolicy?
  reviewAutomationSetting ReviewAutomationSetting?
  reviewRequestLogs     ReviewRequestLog[]
  wallet                Wallet?
  cards                 Card[]
  paymentTransactions   PaymentTransaction[]
  alimTalkConfig        AlimTalkConfig?
  smsCampaigns          SmsCampaign[]
  smsTestLogs           SmsTestLog[]
  externalSmsCampaigns  ExternalSmsCampaign[]
  brandMessageCampaigns BrandMessageCampaign[]
  pointSessions         PointSession[]

  // 웨이팅 서비스
  waitingTypes          WaitingType[]
  waitingList           WaitingList[]
  waitingSetting        WaitingSetting?

  // 방문 경로 추적
  visitSourceSetting    VisitSourceSetting?

  // 리타겟 쿠폰
  retargetCoupons       RetargetCoupon[]

  // 자동 마케팅
  automationRules       AutomationRule[]
  automationLogs        AutomationLog[]

  // 스토어 주문
  storeOrders           StoreOrder[]

  // 고객 설문
  surveyQuestions       SurveyQuestion[]
  surveyAnswers         SurveyAnswer[]

  // 프랜차이즈 통합 스탬프/포인트
  franchiseStampLedger  FranchiseStampLedger[]
  franchisePointLedger  FranchisePointLedger[]

  @@index([franchiseId])
  @@map("stores")
}

// 점주/직원 계정
model StaffUser {
  id           String    @id @default(cuid())
  storeId      String
  email        String    @unique
  passwordHash String
  name         String
  role         StaffRole @default(STAFF)
  isAdmin      Boolean   @default(false) // 시스템 관리자 여부
  profileImage String?
  createdAt    DateTime  @default(now())
  updatedAt    DateTime  @updatedAt

  // Relations
  store       Store         @relation(fields: [storeId], references: [id], onDelete: Cascade)
  pointLedger PointLedger[]

  @@index([storeId])
  @@map("staff_users")
}

enum StaffRole {
  OWNER
  STAFF
}

// 매장 업종 분류
enum StoreCategory {
  // 음식점
  KOREAN           // 한식
  CHINESE          // 중식
  JAPANESE         // 일식
  WESTERN          // 양식
  ASIAN            // 아시안 (베트남, 태국 등)
  BUNSIK           // 분식
  FASTFOOD         // 패스트푸드
  MEAT             // 고기/구이
  SEAFOOD          // 해산물
  BUFFET           // 뷔페
  BRUNCH           // 브런치

  // 카페/디저트
  CAFE             // 카페
  BAKERY           // 베이커리
  DESSERT          // 디저트
  ICECREAM         // 아이스크림

  // 주점
  BEER             // 호프/맥주
  IZAKAYA          // 이자카야
  WINE_BAR         // 와인바
  COCKTAIL_BAR     // 칵테일바
  POCHA            // 포차/실내포장마차
  KOREAN_PUB       // 한식 주점
  COOK_PUB         // 요리주점

  // 기타
  FOODCOURT        // 푸드코트
  OTHER            // 기타
}

// 고객 (매장별로 별도 관리)
model Customer {
  id               String    @id @default(cuid())
  storeId          String
  kakaoId          String?   // 카카오 OAuth 고유 ID (매장별로 별도 고객)
  naverId          String?   // 네이버 OAuth 고유 ID (매장별로 별도 고객)
  naverNickname    String?   // 네이버 닉네임 (리뷰 매칭용)
  name             String?
  phone            String?   // 전화번호 (뒷자리만 저장 가능)
  phoneLastDigits  String?   // 전화번호 뒤 8자리 (검색용)
  gender           Gender?
  ageGroup         AgeGroup? // 연령대 (태블릿 포인트 적립 시 수집)
  birthday         String?   // 생일 (MM-DD 형식)
  birthYear        Int?      // 출생연도 (YYYY)

  // 지역 정보 (매장 주소 기반)
  regionSido       String?   // 시/도 (예: 서울특별시)
  regionSigungu    String?   // 시/군/구 (예: 강남구)

  memo             String?   @db.Text

  // 고객 피드백
  feedbackRating   Int?      // 별점 (1~5)
  feedbackText     String?   @db.Text // 피드백 내용
  feedbackAt       DateTime? // 피드백 작성 시간

  // 마케팅 동의
  consentMarketing Boolean   @default(false)
  consentSms       Boolean   @default(false)
  consentKakao     Boolean   @default(false)
  consentAt        DateTime?

  // 방문 경로
  visitSource      String?   // 방문 경로 옵션 ID (예: "naver", "instagram", "friend")

  // 통계
  visitCount       Int       @default(0)
  totalPoints      Int       @default(0) // 현재 보유 포인트
  totalStamps      Int       @default(0) // 현재 보유 스탬프
  lastVisitAt      DateTime?

  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt

  // Relations
  store             Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  visitsOrOrders    VisitOrOrder[]
  pointLedger       PointLedger[]
  stampLedger       StampLedger[]
  reviewRequestLogs ReviewRequestLog[]
  feedbacks         CustomerFeedback[]
  pointSessions     PointSession[]
  franchiseSmsMessages FranchiseSmsMessage[]
  waitingList       WaitingList[]
  retargetCoupons   RetargetCoupon[]
  surveyAnswers     SurveyAnswer[]
  automationLogs    AutomationLog[]

  @@unique([storeId, kakaoId])  // 매장별 카카오ID 유니크 (null 허용)
  // naverId 유니크 제약조건 제거 - null인 경우가 많아 부분 인덱스로 처리
  @@unique([storeId, phoneLastDigits])
  @@index([storeId])
  @@index([phoneLastDigits])
  @@index([kakaoId])
  @@index([naverId])
  @@index([regionSido, regionSigungu, ageGroup, gender])
  @@index([storeId, visitSource])
  @@map("customers")
}

enum Gender {
  MALE
  FEMALE
}

// 고객 피드백 (누적)
model CustomerFeedback {
  id         String   @id @default(cuid())
  customerId String
  rating     Int      // 별점 (1~5)
  text       String?  @db.Text // 피드백 내용
  createdAt  DateTime @default(now())

  // Relations
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([customerId])
  @@index([createdAt])
  @@map("customer_feedbacks")
}

// 방문/주문 기록
model VisitOrOrder {
  id          String    @id @default(cuid())
  storeId     String
  customerId  String
  orderId     String?   // 외부 주문 ID (POS 등에서 전달)
  visitedAt   DateTime  @default(now())
  items       Json?     // 주문 내역 (선택적)
  totalAmount Int?      // 결제 금액 (선택적)
  createdAt   DateTime  @default(now())

  // Relations
  store    Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@unique([storeId, orderId])
  @@index([storeId])
  @@index([customerId])
  @@map("visits_orders")
}

// 포인트 원장 (적립/사용 내역)
model PointLedger {
  id          String       @id @default(cuid())
  storeId     String
  customerId  String
  staffUserId String?      // 처리한 직원 (nullable: 자동 적립 시)
  delta       Int          // +/- 포인트 (양수: 적립, 음수: 사용)
  balance     Int          // 처리 후 잔액
  type        PointType
  reason      String?      // 사용 사유
  orderId     String?      // 관련 주문 ID
  tableLabel  String?      // 테이블 번호/이름 (예: "A1", "테이블 3")
  createdAt   DateTime     @default(now())

  // Relations
  store     Store      @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer  Customer   @relation(fields: [customerId], references: [id], onDelete: Cascade)
  staffUser StaffUser? @relation(fields: [staffUserId], references: [id], onDelete: SetNull)

  @@index([storeId])
  @@index([customerId])
  @@index([createdAt])
  @@map("point_ledger")
}

enum PointType {
  EARN       // 적립
  USE        // 사용
  EXPIRE     // 만료
  ADJUST     // 조정
}

// 포인트 적립 정책
model PointPolicy {
  id        String          @id @default(cuid())
  storeId   String          @unique
  type      PointPolicyType @default(FIXED)
  value     Int             @default(100) // PERCENT: 비율(%), FIXED: 고정 포인트
  createdAt DateTime        @default(now())
  updatedAt DateTime        @updatedAt

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("point_policies")
}

enum PointPolicyType {
  PERCENT // 결제금액의 N%
  FIXED   // 방문당 고정 포인트
}

// 리뷰 자동 요청 설정
model ReviewAutomationSetting {
  id                  String   @id @default(cuid())
  storeId             String   @unique
  enabled             Boolean  @default(false) // 자동 발송 ON/OFF
  sendFrequency       String   @default("every") // 발송 빈도: "every" (매 주문), "first_only" (첫 주문 1회만)
  benefitText         String?  @db.Text // 혜택 내용 문구
  costPerSend         Int      @default(50) // 건당 비용 (원)
  autoTopupEnabled    Boolean  @default(false) // 자동 충전 ON/OFF
  autoTopupThreshold  Int      @default(10000) // 임계값 (이 금액 이하면 충전)
  autoTopupAmount     Int      @default(100000) // 충전 금액
  naverReviewUrl      String?  // 네이버 리뷰 작성 URL
  createdAt           DateTime @default(now())
  updatedAt           DateTime @updatedAt

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("review_automation_settings")
}

// 리뷰 요청 발송 로그
model ReviewRequestLog {
  id         String              @id @default(cuid())
  storeId    String
  customerId String?
  orderId    String?
  phone      String?
  status     ReviewRequestStatus @default(PENDING)
  cost       Int                 @default(50) // 차감 비용
  failReason String?
  isTest     Boolean             @default(false) // 테스트 발송 여부
  sentAt     DateTime?
  createdAt  DateTime            @default(now())

  // Relations
  store    Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([storeId])
  @@index([createdAt])
  @@map("review_request_logs")
}

enum ReviewRequestStatus {
  PENDING
  SENT
  FAILED
}

// SMS/MMS 테스트 발송 로그
model SmsTestLog {
  id        String   @id @default(cuid())
  storeId   String
  phone     String
  content   String   @db.Text
  type      String   // SMS, LMS, MMS
  hasImage  Boolean  @default(false)
  createdAt DateTime @default(now())

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([createdAt])
  @@map("sms_test_logs")
}

// 매장 지갑 (리뷰 요청 충전금)
model Wallet {
  id        String   @id @default(cuid())
  storeId   String   @unique
  balance   Int      @default(0) // 잔액 (원)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("wallets")
}

// 등록된 결제 카드
model Card {
  id        String   @id @default(cuid())
  storeId   String
  brand     String?  // 카드사 (국민, 신한 등)
  last4     String   // 마지막 4자리
  holderName String?
  expiryMonth Int?
  expiryYear  Int?
  enabled   Boolean  @default(true)
  isDefault Boolean  @default(false)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@map("cards")
}

// 결제 트랜잭션
model PaymentTransaction {
  id        String                   @id @default(cuid())
  storeId   String
  amount    Int                      // 금액
  type      PaymentTransactionType
  status    PaymentTransactionStatus @default(PENDING)
  cardId    String?                  // 사용한 카드
  meta      Json?                    // 추가 정보
  failReason String?
  createdAt DateTime                 @default(now())
  updatedAt DateTime                 @updatedAt

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@index([storeId])
  @@index([createdAt])
  @@map("payment_transactions")
}

enum PaymentTransactionType {
  TOPUP        // 충전
  DEDUCT       // 차감
  SUBSCRIPTION // 구독료
  REFUND       // 환불
  ALIMTALK_SEND // 알림톡 발송
}

enum PaymentTransactionStatus {
  PENDING
  SUCCESS
  FAILED
}

// SOLAPI 알림톡 설정 (매장별)
model AlimTalkConfig {
  id                      String   @id @default(cuid())
  storeId                 String   @unique
  solapiApiKey            String?  // SOLAPI API Key
  solapiApiSecret         String?  // SOLAPI API Secret
  pfId                    String?  // 카카오 채널 ID
  templateIdPointsEarned  String?  // 포인트 적립 템플릿 ID
  templateIdReviewRequest String?  // 리뷰 요청 템플릿 ID
  enabled                 Boolean  @default(false)
  createdAt               DateTime @default(now())
  updatedAt               DateTime @updatedAt

  // Relations
  store Store @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("alimtalk_configs")
}

// 알림톡 발송 Outbox (재시도 및 멱등성 보장)
model AlimTalkOutbox {
  id            String             @id @default(cuid())
  storeId       String
  customerId    String?
  phone         String             // 수신자 전화번호
  messageType   AlimTalkType       // 메시지 유형
  templateId    String             // 사용된 템플릿 ID
  variables     Json               // 템플릿 변수 (JSON)
  status        AlimTalkStatus     @default(PENDING)
  retryCount    Int                @default(0)
  maxRetries    Int                @default(3)
  idempotencyKey String            @unique // 중복 발송 방지 키
  solapiMessageId String?          // SOLAPI 메시지 ID (발송 후)
  failReason    String?            @db.Text
  scheduledAt   DateTime?          // 예약 발송 시간 (null = 즉시)
  sentAt        DateTime?          // 실제 발송 시간
  createdAt     DateTime           @default(now())
  updatedAt     DateTime           @updatedAt

  @@index([storeId])
  @@index([status, scheduledAt])
  @@index([idempotencyKey])
  @@index([createdAt])
  @@map("alimtalk_outbox")
}

enum AlimTalkType {
  POINTS_EARNED         // 포인트 적립 알림
  STAMP_EARNED          // 스탬프 적립 알림
  NAVER_REVIEW_REQUEST  // 네이버 리뷰 요청
  LOW_BALANCE           // 충전금 부족 안내
  WAITING_REGISTERED    // 웨이팅 등록 완료 알림
  WAITING_CALLED        // 웨이팅 호출 알림
  WAITING_CANCELLED     // 웨이팅 취소 알림
  RETARGET_COUPON       // 리타겟 쿠폰 발송
  AUTO_BIRTHDAY         // 생일 자동화
  AUTO_CHURN            // 이탈 방지 자동화
  AUTO_ANNIVERSARY      // 가입 기념일 자동화
  AUTO_FIRST_VISIT      // 첫 방문 팔로업 자동화
  AUTO_VIP_MILESTONE    // VIP 마일스톤 자동화
  AUTO_WINBACK          // 장기 미방문 윈백 자동화
  AUTO_SLOW_DAY         // 비수기 프로모션 자동화
}

enum AlimTalkStatus {
  PENDING    // 대기 중
  PROCESSING // 처리 중
  SENT       // 발송 완료
  FAILED     // 발송 실패 (재시도 불가)
  RETRY      // 재시도 대기
}

// SMS 캠페인 (대량 문자 발송)
model SmsCampaign {
  id            String           @id @default(cuid())
  storeId       String
  title         String           // 캠페인 제목
  content       String           @db.Text // 메시지 내용
  targetType    SmsTargetType    // ALL, REVISIT, NEW, CUSTOM
  targetCount   Int              // 발송 대상 수
  sentCount     Int              @default(0) // 발송 완료 수
  failedCount   Int              @default(0) // 실패 수
  totalCost     Int              @default(0) // 총 비용
  status        SmsCampaignStatus @default(PENDING)
  scheduledAt   DateTime?        // 예약 발송 시간
  completedAt   DateTime?        // 완료 시간
  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  // Relations
  store    Store              @relation(fields: [storeId], references: [id], onDelete: Cascade)
  messages SmsMessage[]

  @@index([storeId])
  @@index([status])
  @@index([createdAt])
  @@map("sms_campaigns")
}

// SMS 개별 메시지
model SmsMessage {
  id            String         @id @default(cuid())
  campaignId    String
  storeId       String
  customerId    String?
  phone         String         // 수신자 전화번호
  content       String         @db.Text // 실제 발송 내용 ({고객명} 치환 후)
  status        SmsMessageStatus @default(PENDING)
  solapiGroupId   String?      // SOLAPI 그룹 ID (결과 조회용)
  solapiMessageId String?      // SOLAPI 메시지 ID
  failReason    String?
  cost          Int            @default(0) // 발송 비용
  sentAt        DateTime?
  createdAt     DateTime       @default(now())

  // Relations
  campaign SmsCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([storeId])
  @@index([status])
  @@map("sms_messages")
}

enum SmsTargetType {
  ALL      // 전체 고객
  REVISIT  // 재방문 고객 (2회 이상)
  NEW      // 신규 고객 (최근 30일)
  CUSTOM   // 직접 선택
}

enum SmsCampaignStatus {
  PENDING    // 대기
  SENDING    // 발송 중
  COMPLETED  // 완료
  CANCELLED  // 취소
}

enum SmsMessageStatus {
  PENDING    // 대기
  SENT       // 발송 완료
  FAILED     // 실패
}

// 네이버 리뷰 통계 기록 (일별)
model NaverReviewStats {
  id             String   @id @default(cuid())
  storeId        String
  date           DateTime @db.Date
  visitorReviews Int      @default(0) // 방문자 리뷰 수
  blogReviews    Int      @default(0) // 블로그 리뷰 수
  totalReviews   Int      @default(0) // 총 리뷰 수
  createdAt      DateTime @default(now())
  updatedAt      DateTime @updatedAt

  @@unique([storeId, date])
  @@index([storeId])
  @@index([date])
  @@map("naver_review_stats")
}

// 공지사항 (전체 매장 대상, 어드민 전용)
model Announcement {
  id        String   @id @default(cuid())
  title     String   // 공지 제목
  content   String   @db.Text // 공지 내용
  isActive  Boolean  @default(true) // 활성화 여부
  priority  Int      @default(0) // 우선순위 (높을수록 상단)
  startAt   DateTime? // 노출 시작일 (null = 즉시)
  endAt     DateTime? // 노출 종료일 (null = 무기한)
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([isActive, priority])
  @@index([startAt, endAt])
  @@map("announcements")
}

// 주문완료 배너 (바텀모달용, 어드민 전용)
model OrderCompleteBanner {
  id            String          @id @default(cuid())
  title         String          // 배너 제목 (관리용)
  imageUrl      String          // 배너 이미지/영상 URL
  linkUrl       String?         // 클릭 시 이동할 URL (선택)
  mediaType     BannerMediaType @default(IMAGE) // 미디어 타입
  isActive      Boolean         @default(true) // 활성화 여부
  order         Int             @default(0) // 정렬 순서 (낮을수록 먼저)
  autoSlide     Boolean         @default(true) // 자동 슬라이드 여부
  slideInterval Int             @default(3000) // 슬라이드 간격 (ms)
  targetSlugs   String[]        // 표시할 매장 slug 목록 (빈 배열 = 전체)
  createdAt     DateTime        @default(now())
  updatedAt     DateTime        @updatedAt

  @@index([isActive, order])
  @@map("order_complete_banners")
}

enum BannerMediaType {
  IMAGE
  VIDEO
}

// ============================================
// 우리동네 손님 찾기 (외부 고객 마케팅)
// ============================================

// 연령대 enum
enum AgeGroup {
  TWENTIES    // 20대
  THIRTIES    // 30대
  FORTIES     // 40대
  FIFTIES     // 50대
  SIXTY_PLUS  // 60대 이상
}

// 외부 고객 (태그히어 제공 DB)
model ExternalCustomer {
  id                  String    @id @default(cuid())
  phone               String    @unique
  ageGroup            AgeGroup
  gender              Gender?
  regionSido          String              // 시/도
  regionSigungu       String              // 시/군/구
  preferredCategories String?   @db.Text  // JSON: ["KOREAN", "CAFE", "MEAT"] - 선호 업종
  consentMarketing    Boolean   @default(true)
  consentAt           DateTime
  createdAt           DateTime  @default(now())

  // Relations
  weeklySlots      ExternalCustomerWeeklySlot[]
  sentMessages     ExternalSmsMessage[]

  @@index([ageGroup, gender, regionSido, regionSigungu])
  @@map("external_customers")
}

// 외부 고객 주간 슬롯 (1주에 최대 2회 발송 제한)
model ExternalCustomerWeeklySlot {
  id                 String   @id @default(cuid())
  externalCustomerId String
  weekStart          DateTime @db.Date  // 해당 주 월요일
  slotUsed           Int      @default(0)  // 사용된 슬롯 (최대 2)

  // Relations
  externalCustomer   ExternalCustomer @relation(fields: [externalCustomerId], references: [id], onDelete: Cascade)

  @@unique([externalCustomerId, weekStart])
  @@index([weekStart])
  @@map("external_customer_weekly_slots")
}

// 외부 SMS 캠페인 상태
enum ExternalSmsCampaignStatus {
  PENDING    // 대기
  SENDING    // 발송 중
  COMPLETED  // 완료
  CANCELLED  // 취소
}

// 외부 SMS 캠페인 (우리동네 손님 찾기)
model ExternalSmsCampaign {
  id                  String                    @id @default(cuid())
  storeId             String?                   // Store ID (nullable for franchise campaigns)
  franchiseId         String?                   // Franchise ID (nullable for store campaigns)
  title               String                    // 캠페인 제목
  content             String                    @db.Text // 메시지 내용
  filterAgeGroups     String                    // JSON: ["TWENTIES", "THIRTIES"]
  filterGender        String?                   // MALE, FEMALE, null(전체)
  filterRegionSido    String                    // 시/도
  filterRegionSigungu String                    // 시/군/구
  filterCategories    String?                   @db.Text // JSON: ["KOREAN", "CAFE"] - 선호 업종 필터
  targetCount         Int                       // 발송 대상 수
  sentCount           Int                       @default(0) // 발송 완료 수
  failedCount         Int                       @default(0) // 실패 수
  costPerMessage      Int                       @default(250) // 건당 비용
  totalCost           Int                       @default(0) // 총 비용
  status              ExternalSmsCampaignStatus @default(PENDING)
  createdAt           DateTime                  @default(now())
  updatedAt           DateTime                  @updatedAt

  // Relations
  store               Store?                    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  franchise           Franchise?                @relation(fields: [franchiseId], references: [id], onDelete: Cascade)
  messages            ExternalSmsMessage[]

  @@index([storeId])
  @@index([franchiseId])
  @@index([status])
  @@index([createdAt])
  @@map("external_sms_campaigns")
}

// 외부 SMS 메시지
model ExternalSmsMessage {
  id                 String           @id @default(cuid())
  campaignId         String
  storeId            String?          // Store ID (nullable for franchise campaigns)
  franchiseId        String?          // Franchise ID (nullable for store campaigns)
  externalCustomerId String?          // External Customer ID (nullable for CRM customer campaigns)
  content            String           @db.Text
  status             SmsMessageStatus @default(PENDING)
  solapiGroupId      String?
  solapiMessageId    String?
  failReason         String?
  cost               Int              @default(250)
  sentAt             DateTime?
  createdAt          DateTime         @default(now())

  // Relations
  campaign           ExternalSmsCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)
  externalCustomer   ExternalCustomer?   @relation(fields: [externalCustomerId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([storeId])
  @@index([franchiseId])
  @@index([status])
  @@map("external_sms_messages")
}

// 한국 지역 데이터 (시/도, 시/군/구)
model KoreaRegion {
  id        String @id @default(cuid())
  sido      String
  sigungu   String

  @@unique([sido, sigungu])
  @@index([sido])
  @@map("korea_regions")
}

// ============================================
// 카카오톡 브랜드 메시지 자유형
// ============================================

// 브랜드 메시지 캠페인
model BrandMessageCampaign {
  id              String                    @id @default(cuid())
  storeId         String
  content         String                    @db.Text // 메시지 내용
  messageType     BrandMessageType          // TEXT, IMAGE
  imageUrl        String?                   // 이미지 URL (IMAGE 타입)
  imageId         String?                   // Solapi 이미지 ID
  buttons         Json?                     // [{type: 'WL', name, linkMo, linkPc}]
  targetType      SmsTargetType             // ALL, REVISIT, NEW, CUSTOM
  genderFilter    String?                   // MALE, FEMALE, null(전체)
  ageGroups       Json?                     // ["TWENTIES", "THIRTIES", ...]
  targetCount     Int                       // 발송 대상 수
  sentCount       Int                       @default(0) // 발송 완료 수
  failedCount     Int                       @default(0) // 실패 수
  totalCost       Int                       @default(0) // 총 비용
  costPerMessage  Int                       // 200 (TEXT) or 230 (IMAGE)
  status          BrandMessageCampaignStatus @default(PENDING)
  scheduledAt     DateTime?                 // 예약 발송 시간
  completedAt     DateTime?                 // 완료 시간
  createdAt       DateTime                  @default(now())
  updatedAt       DateTime                  @updatedAt

  // Relations
  store    Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)
  messages BrandMessage[]

  @@index([storeId])
  @@index([status])
  @@index([scheduledAt])
  @@index([createdAt])
  @@map("brand_message_campaigns")
}

// 브랜드 메시지 개별 발송
model BrandMessage {
  id              String              @id @default(cuid())
  campaignId      String
  storeId         String
  customerId      String?
  phone           String              // 수신자 전화번호
  content         String              @db.Text // 실제 발송 내용
  status          BrandMessageStatus  @default(PENDING)
  solapiGroupId   String?             // Solapi 그룹 ID
  solapiMessageId String?             // Solapi 메시지 ID
  failReason      String?
  cost            Int                 @default(0) // 발송 비용
  sentAt          DateTime?
  createdAt       DateTime            @default(now())

  // Relations
  campaign BrandMessageCampaign @relation(fields: [campaignId], references: [id], onDelete: Cascade)

  @@index([campaignId])
  @@index([storeId])
  @@index([status])
  @@map("brand_messages")
}

enum BrandMessageType {
  TEXT   // 텍스트형 (200원)
  IMAGE  // 이미지형 (230원)
}

enum BrandMessageCampaignStatus {
  PENDING    // 대기 (예약 발송 대기)
  SCHEDULED  // 예약됨
  SENDING    // 발송 중
  COMPLETED  // 완료
  CANCELLED  // 취소
}

enum BrandMessageStatus {
  PENDING    // 대기
  SENT       // 발송 완료
  FAILED     // 실패
}

// ============================================
// 포인트 세션 (POS-태블릿 연동)
// ============================================

// 포인트 세션 상태
enum PointSessionStatus {
  PENDING     // 대기 중 (태블릿에서 표시)
  COMPLETED   // 적립 완료
  EXPIRED     // 만료됨
  CANCELLED   // 취소됨
}

// 포인트 세션 (POS에서 생성, 태블릿에서 조회)
model PointSession {
  id              String              @id @default(cuid())
  storeId         String
  paymentAmount   Int                 // 결제 금액
  earnPoints      Int                 // 적립 포인트
  status          PointSessionStatus  @default(PENDING)
  customerId      String?             // 적립 완료 시 고객 ID
  createdAt       DateTime            @default(now())
  expiresAt       DateTime            // 5분 후 자동 만료
  completedAt     DateTime?

  // Relations
  store           Store               @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer        Customer?           @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([storeId, status])
  @@index([expiresAt])
  @@map("point_sessions")
}

// ============================================
// 프랜차이즈 시스템
// ============================================

// 프랜차이즈 역할
enum FranchiseRole {
  OWNER    // 본사 대표
  MANAGER  // 본사 담당자
}

// 프랜차이즈 (브랜드)
model Franchise {
  id            String   @id @default(cuid())
  name          String   // 브랜드명
  slug          String   @unique
  logoUrl       String?
  logo          Bytes?   // 로고 이미지 파일 (DB 저장)
  logoMimeType  String?  // 로고 MIME 타입 (image/png, image/jpeg 등)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt

  users                  FranchiseUser[]
  stores                 Store[]
  wallet                 FranchiseWallet?
  smsCampaigns           FranchiseSmsCampaign[]
  smsTestLogs            FranchiseSmsTestLog[]
  externalSmsCampaigns   ExternalSmsCampaign[]

  // 통합 스탬프/포인트
  franchiseCustomers     FranchiseCustomer[]
  franchiseStampSetting  FranchiseStampSetting?
  franchiseStampLedger   FranchiseStampLedger[]
  franchisePointLedger   FranchisePointLedger[]
  rewardClaims           RewardClaim[]

  @@map("franchises")
}

// 프랜차이즈 본사 계정
model FranchiseUser {
  id            String         @id @default(cuid())
  email         String         @unique
  passwordHash  String
  name          String
  phone         String?
  role          FranchiseRole  @default(MANAGER)
  createdAt     DateTime       @default(now())
  updatedAt     DateTime       @updatedAt

  franchiseId   String
  franchise     Franchise @relation(fields: [franchiseId], references: [id])

  @@index([franchiseId])
  @@map("franchise_users")
}

// 프랜차이즈 지갑
model FranchiseWallet {
  id            String   @id @default(cuid())
  balance       Int      @default(0)
  franchiseId   String   @unique
  franchise     Franchise @relation(fields: [franchiseId], references: [id])
  transactions  FranchiseTransaction[]

  @@map("franchise_wallets")
}

// 프랜차이즈 결제 트랜잭션
model FranchiseTransaction {
  id            String                   @id @default(cuid())
  amount        Int
  type          PaymentTransactionType
  description   String?
  meta          Json?
  createdAt     DateTime                 @default(now())

  walletId      String
  wallet        FranchiseWallet @relation(fields: [walletId], references: [id])

  @@index([walletId])
  @@index([createdAt])
  @@map("franchise_transactions")
}

// 프랜차이즈 SMS 캠페인
model FranchiseSmsCampaign {
  id            String   @id @default(cuid())
  franchiseId   String
  content       String   @db.Text
  messageType   String   // "SMS" | "LMS" | "MMS"
  targetType    String   // "ALL" | "REVISIT" | "NEW" | "CUSTOM"
  targetCount   Int
  sentCount     Int      @default(0)
  costPerMessage Int
  totalCost     Int
  genderFilter  String?
  ageGroups     String?  // JSON array
  imageUrl      String?
  status        String   // "PENDING" | "COMPLETED" | "FAILED"
  createdAt     DateTime @default(now())

  franchise     Franchise @relation(fields: [franchiseId], references: [id])
  messages      FranchiseSmsMessage[]

  @@index([franchiseId, createdAt])
  @@map("franchise_sms_campaigns")
}

// 프랜차이즈 SMS 메시지 (개별 발송 기록)
model FranchiseSmsMessage {
  id         String   @id @default(cuid())
  campaignId String
  customerId String
  phone      String
  content    String   @db.Text
  messageType String
  cost       Int
  status     String   // "SENT" | "DELIVERED" | "FAILED"
  sentAt     DateTime @default(now())

  campaign   FranchiseSmsCampaign @relation(fields: [campaignId], references: [id])
  customer   Customer @relation(fields: [customerId], references: [id])

  @@index([campaignId])
  @@index([customerId])
  @@map("franchise_sms_messages")
}

// 프랜차이즈 SMS 테스트 로그
model FranchiseSmsTestLog {
  id          String   @id @default(cuid())
  franchiseId String
  phone       String
  content     String   @db.Text
  createdAt   DateTime @default(now())

  franchise   Franchise @relation(fields: [franchiseId], references: [id])

  @@index([franchiseId, createdAt])
  @@map("franchise_sms_test_logs")
}

// ============================================
// 웨이팅 서비스
// ============================================

enum WaitingStatus {
  WAITING     // 대기 중
  CALLED      // 호출됨 (타이머 진행 중)
  SEATED      // 착석 완료
  CANCELLED   // 취소됨
  NO_SHOW     // 노쇼
}

enum WaitingSource {
  QR          // QR 코드 스캔
  TABLET      // 태블릿
  MANUAL      // 직원 수동 등록
}

enum CancelReason {
  CUSTOMER_REQUEST   // 고객 요청
  STORE_REASON       // 매장 사정
  OUT_OF_STOCK       // 재고 소진
  NO_SHOW            // 고객 미방문
  AUTO_CANCELLED     // 자동 취소 (호출 후 미입장)
}

enum WaitingOperationStatus {
  ACCEPTING       // 웨이팅 접수 중
  WALK_IN         // 바로 입장 가능
  PAUSED          // 일시정지
  CLOSED          // 운영 종료
}

// 웨이팅 유형 (홀 2인석, 홀 4인석, 포장 등)
model WaitingType {
  id                  String          @id @default(cuid())
  storeId             String

  name                String          // "홀 2인석", "홀 4인석", "포장" 등
  description         String?         // 설명 (선택)
  avgWaitTimePerTeam  Int             @default(5)  // 1팀당 예상 대기 시간 (분)
  minPartySize        Int             @default(0)  // 최소 인원 제한 (0 = 제한 없음)
  maxPartySize        Int             @default(20) // 최대 인원 제한
  sortOrder           Int             @default(0)  // 정렬 순서
  isActive            Boolean         @default(true)

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  store               Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  waitingList         WaitingList[]

  @@index([storeId, isActive])
  @@map("waiting_types")
}

// 웨이팅 목록
model WaitingList {
  id                  String          @id @default(cuid())
  storeId             String
  customerId          String?         // CRM 고객 연결
  waitingTypeId       String          // 웨이팅 유형 (홀2인석, 홀4인석, 포장 등)

  // 웨이팅 정보
  waitingNumber       Int             // 당일 웨이팅 번호 (324, 325...)
  phone               String?         // 연락처 (수기 등록 시 없을 수 있음)
  phoneLastDigits     String?         // 뒤 4자리 (마스킹용)
  name                String?         // 이름 (수기 등록용)
  partySize           Int             // 총 인원 수 (adultCount + childCount)
  adultCount          Int?            // 성인 인원 (null이면 레거시 데이터)
  childCount          Int?            // 유아 인원 (null이면 레거시 데이터)
  memo                String?         @db.Text  // 요청사항/메모

  // 상태 관리
  status              WaitingStatus   @default(WAITING)

  // 호출 관리
  calledAt            DateTime?       // 최초 호출 시간
  calledCount         Int             @default(0)  // 호출 횟수 (최대 2회)
  callExpireAt        DateTime?       // 호출 만료 시간 (타이머 용)

  // 완료 처리
  seatedAt            DateTime?       // 착석 시간
  cancelledAt         DateTime?       // 취소 시간
  cancelReason        CancelReason?   // 취소 사유

  // 예상 시간
  estimatedWaitMinutes Int?           // 예상 대기 시간 (분)

  // 등록 경로
  source              WaitingSource   @default(QR)

  // 마케팅 동의
  consentMarketing    Boolean         @default(false)

  // 순서 미루기 여부
  isDeferred          Boolean         @default(false)

  createdAt           DateTime        @default(now())
  updatedAt           DateTime        @updatedAt

  store               Store           @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer            Customer?       @relation(fields: [customerId], references: [id])
  waitingType         WaitingType     @relation(fields: [waitingTypeId], references: [id])

  @@index([storeId, status])
  @@index([storeId, createdAt])
  @@index([storeId, waitingTypeId, status])
  @@index([phone])
  @@map("waiting_list")
}

// 웨이팅 설정
model WaitingSetting {
  id                      String                  @id @default(cuid())
  storeId                 String                  @unique

  // 운영 상태
  operationStatus         WaitingOperationStatus  @default(ACCEPTING)
  pauseMessage            String?                 // 일시정지 안내 문구
  pauseEndTime            DateTime?               // 일시정지 종료 시간

  // 기본 설정
  enabled                 Boolean                 @default(true)
  maxWaitingCount         Int                     @default(50)     // 최대 대기 인원
  showEstimatedTime       Boolean                 @default(true)   // 예상 시간 노출 여부

  // 호출 설정
  callTimeoutMinutes      Int                     @default(3)      // 호출 후 대기 시간 (분)
  maxCallCount            Int                     @default(2)      // 최대 호출 횟수
  autoCancel              Boolean                 @default(true)   // 자동 취소 여부

  // 자주 쓰는 메모
  quickMemos              Json?                   // ["창가석", "유아동반", "휠체어", "VIP"]

  // 알림톡 안내 메시지
  waitingNote             String?                 // 웨이팅 등록 알림톡에 포함할 매장 안내 메시지
  waitingCallNote         String?                 // 호출 알림톡에 포함할 매장 유의사항

  createdAt               DateTime                @default(now())
  updatedAt               DateTime                @updatedAt

  store                   Store                   @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("waiting_settings")
}

// ============================================
// 방문 경로 추적 시스템
// ============================================

// 방문 경로 설정 (매장별)
model VisitSourceSetting {
  id        String   @id @default(cuid())
  storeId   String   @unique

  // 기능 ON/OFF
  enabled   Boolean  @default(false)

  // 방문 경로 옵션 (JSON 배열)
  // 기본값: 단순 재방문, 지인 추천, 네이버, 유튜브, 당근, 인스타그램, 문자, 카카오톡, 지나가다
  options   Json     @default("[{\"id\":\"revisit\",\"label\":\"단순 재방문\",\"order\":1,\"enabled\":true},{\"id\":\"friend\",\"label\":\"지인 추천\",\"order\":2,\"enabled\":true},{\"id\":\"naver\",\"label\":\"네이버\",\"order\":3,\"enabled\":true},{\"id\":\"youtube\",\"label\":\"유튜브\",\"order\":4,\"enabled\":true},{\"id\":\"daangn\",\"label\":\"당근\",\"order\":5,\"enabled\":true},{\"id\":\"instagram\",\"label\":\"인스타그램\",\"order\":6,\"enabled\":true},{\"id\":\"sms\",\"label\":\"문자\",\"order\":7,\"enabled\":true},{\"id\":\"kakao\",\"label\":\"카카오톡\",\"order\":8,\"enabled\":true},{\"id\":\"passby\",\"label\":\"지나가다\",\"order\":9,\"enabled\":true}]")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  // Relations
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("visit_source_settings")
}

// ============================================
// 스탬프 적립 시스템
// ============================================

// 스탬프 설정 (매장별)
model StampSetting {
  id                    String   @id @default(cuid())
  storeId               String   @unique

  // 기본 설정
  enabled               Boolean  @default(false)

  // 보상 설정 (5개 단위, 최대 30개)
  reward5Description    String?  // 5개 보상 설명 (예: "아메리카노 1잔 무료")
  reward10Description   String?  // 10개 보상 설명 (예: "케이크 세트 무료")
  reward15Description   String?  // 15개 보상 설명
  reward20Description   String?  // 20개 보상 설명
  reward25Description   String?  // 25개 보상 설명
  reward30Description   String?  // 30개 보상 설명

  // 랜덤 보상 옵션 (JSON: [{description: string, probability: number}])
  reward5Options        Json?    // 5개 랜덤 보상 옵션
  reward10Options       Json?    // 10개 랜덤 보상 옵션
  reward15Options       Json?    // 15개 랜덤 보상 옵션
  reward20Options       Json?    // 20개 랜덤 보상 옵션
  reward25Options       Json?    // 25개 랜덤 보상 옵션
  reward30Options       Json?    // 30개 랜덤 보상 옵션

  // 보상 설정 (JSON 배열, 1~50 자유 티어)
  // [{tier: 3, description: "아메리카노", options: [{description, probability}] | null}]
  rewards               Json?

  // 알림톡 설정
  alimtalkEnabled       Boolean  @default(true)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  // Relations
  store                 Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@map("stamp_settings")
}

// 스탬프 거래 내역
model StampLedger {
  id              String           @id @default(cuid())
  storeId         String
  customerId      String

  type            StampLedgerType  // EARN, USE_5, USE_10, ADMIN_ADD, ADMIN_REMOVE
  delta           Int              // 변동량 (+1, -5, -10 등)
  balance         Int              // 변동 후 잔액

  // 적립 시 추가 정보
  ordersheetId    String?          // 태그히어 주문 연동 시
  earnMethod      StampEarnMethod? // TAGHERE_ORDER, NFC_TAG, QR_CODE, MANUAL
  tableLabel      String?          // 테이블 번호/이름 (예: "A1", "테이블 3")

  reason          String?          // 관리자 메모 등

  // 보상 당첨 기록
  drawnReward     String?          // 마일스톤 도달 시 당첨된 보상 설명
  drawnRewardTier Int?             // 마일스톤 단계 (5, 10, 15, 20, 25, 30)

  createdAt       DateTime         @default(now())

  // Relations
  store           Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer        Customer         @relation(fields: [customerId], references: [id], onDelete: Cascade)

  @@index([storeId, customerId])
  @@index([customerId])
  @@index([createdAt])
  @@map("stamp_ledger")
}

enum StampLedgerType {
  EARN          // 적립 (+1)
  USE           // 보상 사용 (임의 티어)
  USE_5         // 5개 사용 (-5) [레거시]
  USE_10        // 10개 사용 (-10) [레거시]
  USE_15        // 15개 사용 (-15) [레거시]
  USE_20        // 20개 사용 (-20) [레거시]
  USE_25        // 25개 사용 (-25) [레거시]
  USE_30        // 30개 사용 (-30) [레거시]
  ADMIN_ADD     // 관리자 추가
  ADMIN_REMOVE  // 관리자 차감
}

enum StampEarnMethod {
  TAGHERE_ORDER   // 태그히어 주문 연동
  NFC_TAG         // NFC 태그
  QR_CODE         // QR 코드
  MANUAL          // 수동 입력
}

// ============================================
// 월별 무료 메시지 크레딧
// ============================================

// 월별 무료 크레딧 (매장별)
model MonthlyCredit {
  id              String   @id @default(cuid())
  storeId         String
  yearMonth       String   // "2026-01" 형식
  totalCredits    Int      @default(30)   // 제공 크레딧 (기본 30건)
  usedCredits     Int      @default(0)    // 사용한 크레딧
  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  // Relations
  usageLogs       CreditUsageLog[]

  @@unique([storeId, yearMonth])
  @@index([storeId])
  @@index([yearMonth])
  @@map("monthly_credits")
}

// 크레딧 사용 내역
model CreditUsageLog {
  id              String   @id @default(cuid())
  monthlyCreditId String
  campaignId      String?  // SmsCampaign 또는 BrandMessageCampaign ID
  messageType     String   // "SMS", "LMS", "MMS", "KAKAO_TEXT", "KAKAO_IMAGE"
  usedCount       Int      // 사용 건수
  createdAt       DateTime @default(now())

  // Relations
  monthlyCredit   MonthlyCredit @relation(fields: [monthlyCreditId], references: [id], onDelete: Cascade)

  @@index([monthlyCreditId])
  @@index([createdAt])
  @@map("credit_usage_logs")
}

// ============================================
// 리타겟 쿠폰 (카카오톡 알림톡)
// ============================================

// 리타겟 쿠폰
model RetargetCoupon {
  id              String    @id @default(cuid())
  code            String    @unique  // 고유 코드 (10자리)
  storeId         String
  customerId      String?
  phone           String              // 수신자 전화번호
  couponContent   String              // 쿠폰 내용
  expiryDate      String              // 유효기간 텍스트
  naverPlaceUrl   String?             // 네이버 플레이스 URL
  usedAt          DateTime?           // 사용 완료 시간
  usedBy          String?             // 사용 처리자 정보
  createdAt       DateTime  @default(now())

  // Relations
  store           Store     @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customer        Customer? @relation(fields: [customerId], references: [id], onDelete: SetNull)

  @@index([storeId])
  @@index([code])
  @@index([phone])
  @@map("retarget_coupons")
}

// ============================================
// 스토어 상품 판매
// ============================================

// 스토어 상품
model StoreProduct {
  id          String   @id @default(cuid())
  name        String
  description String?
  price       Int      // 원 단위
  imageUrl    String?
  isActive    Boolean  @default(true)
  sortOrder   Int      @default(0)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  orderItems  StoreOrderItem[]

  @@map("store_products")
}

// 스토어 주문
model StoreOrder {
  id            String           @id @default(cuid())
  orderNumber   String           @unique // 주문번호
  storeId       String           // 구매한 매장 ID
  store         Store            @relation(fields: [storeId], references: [id])

  customerName  String
  customerPhone String
  customerEmail String?

  totalAmount   Int
  status        StoreOrderStatus @default(PENDING)

  paymentKey    String?          // TossPayments 결제키
  paidAt        DateTime?

  createdAt     DateTime         @default(now())
  updatedAt     DateTime         @updatedAt

  items         StoreOrderItem[]

  @@index([storeId])
  @@index([status])
  @@index([createdAt])
  @@map("store_orders")
}

// 스토어 주문 아이템
model StoreOrderItem {
  id          String       @id @default(cuid())
  orderId     String
  order       StoreOrder   @relation(fields: [orderId], references: [id], onDelete: Cascade)
  productId   String
  product     StoreProduct @relation(fields: [productId], references: [id])

  productName String       // 주문 시점의 상품명
  price       Int          // 주문 시점의 가격
  quantity    Int          @default(1)

  createdAt   DateTime     @default(now())

  @@index([orderId])
  @@index([productId])
  @@map("store_order_items")
}

enum StoreOrderStatus {
  PENDING     // 결제 대기
  PAID        // 결제 완료
  CANCELLED   // 취소됨
}

// ============================================
// 외부 매출 (계좌이체 등)
// ============================================

// 외부 매출 기록
model ExternalRevenue {
  id          String   @id @default(cuid())
  amount      Int      // 금액
  description String?  // 설명 (예: "계좌이체", "현금")
  revenueDate DateTime // 매출 발생일
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([revenueDate])
  @@index([createdAt])
  @@map("external_revenues")
}

// ============================================
// 고객 설문
// ============================================

enum SurveyQuestionType {
  DATE
}

model SurveyQuestion {
  id          String             @id @default(cuid())
  storeId     String
  type        SurveyQuestionType
  label       String             // 질문 텍스트
  description String?            // 보조 설명
  enabled     Boolean            @default(true)
  required    Boolean            @default(false)
  order       Int                @default(0)
  dateConfig  Json?              // { autoSendEnabled, autoSendDaysBefore, autoSendTemplateId }

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  store       Store            @relation(fields: [storeId], references: [id], onDelete: Cascade)
  answers     SurveyAnswer[]

  @@index([storeId, enabled])
  @@map("survey_questions")
}

model SurveyAnswer {
  id          String   @id @default(cuid())
  questionId  String
  customerId  String
  storeId     String
  valueDate   DateTime?
  valueText   String?
  valueJson   Json?

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  question    SurveyQuestion @relation(fields: [questionId], references: [id], onDelete: Cascade)
  customer    Customer       @relation(fields: [customerId], references: [id], onDelete: Cascade)
  store       Store          @relation(fields: [storeId], references: [id], onDelete: Cascade)

  @@unique([questionId, customerId])
  @@index([storeId, questionId])
  @@index([customerId])
  @@index([valueDate])
  @@map("survey_answers")
}

// ============================================
// 프랜차이즈 통합 스탬프/포인트
// ============================================

// 프랜차이즈 통합 고객
model FranchiseCustomer {
  id            String    @id @default(cuid())
  franchiseId   String
  kakaoId       String
  phone         String?
  name          String?
  totalStamps   Int       @default(0)
  totalPoints   Int       @default(0)
  visitCount    Int       @default(0)
  lastVisitAt   DateTime?
  createdAt     DateTime  @default(now())
  updatedAt     DateTime  @updatedAt

  franchise     Franchise              @relation(fields: [franchiseId], references: [id])
  stampLedger   FranchiseStampLedger[]
  pointLedger   FranchisePointLedger[]
  rewardClaims  RewardClaim[]

  @@unique([franchiseId, kakaoId])
  @@index([franchiseId])
  @@index([kakaoId])
  @@map("franchise_customers")
}

// 프랜차이즈 통합 스탬프 보상 설정
model FranchiseStampSetting {
  id                    String   @id @default(cuid())
  franchiseId           String   @unique

  // 기본 설정
  enabled               Boolean  @default(true)

  // 보상 설정 (레거시 5개 단위)
  reward5Description    String?
  reward10Description   String?
  reward15Description   String?
  reward20Description   String?
  reward25Description   String?
  reward30Description   String?
  reward5Options        Json?
  reward10Options       Json?
  reward15Options       Json?
  reward20Options       Json?
  reward25Options       Json?
  reward30Options       Json?

  // 보상 설정 (JSON 배열, 1~50 자유 티어)
  rewards               Json?

  // 알림톡 설정
  alimtalkEnabled       Boolean  @default(true)

  // 고객 셀프 보상 신청
  selfClaimEnabled      Boolean  @default(false)

  createdAt             DateTime @default(now())
  updatedAt             DateTime @updatedAt

  franchise             Franchise @relation(fields: [franchiseId], references: [id])

  @@map("franchise_stamp_settings")
}

// 프랜차이즈 통합 스탬프 거래 내역
model FranchiseStampLedger {
  id                    String           @id @default(cuid())
  franchiseId           String
  franchiseCustomerId   String
  storeId               String           // 적립/사용한 매장
  type                  StampLedgerType
  delta                 Int
  balance               Int
  earnMethod            StampEarnMethod?
  ordersheetId          String?
  drawnReward           String?
  drawnRewardTier       Int?
  reason                String?
  createdAt             DateTime         @default(now())

  franchise             Franchise         @relation(fields: [franchiseId], references: [id])
  customer              FranchiseCustomer @relation(fields: [franchiseCustomerId], references: [id])
  store                 Store             @relation(fields: [storeId], references: [id])

  @@index([franchiseId, franchiseCustomerId])
  @@index([franchiseCustomerId])
  @@index([createdAt])
  @@map("franchise_stamp_ledger")
}

// 프랜차이즈 통합 포인트 거래 내역
model FranchisePointLedger {
  id                    String    @id @default(cuid())
  franchiseId           String
  franchiseCustomerId   String
  storeId               String           // 적립/사용한 매장
  delta                 Int
  balance               Int
  type                  PointType
  reason                String?
  orderId               String?
  tableLabel            String?
  createdAt             DateTime  @default(now())

  franchise             Franchise         @relation(fields: [franchiseId], references: [id])
  customer              FranchiseCustomer @relation(fields: [franchiseCustomerId], references: [id])
  store                 Store             @relation(fields: [storeId], references: [id])

  @@index([franchiseId, franchiseCustomerId])
  @@index([franchiseCustomerId])
  @@index([createdAt])
  @@map("franchise_point_ledger")
}

// ─── 자동 마케팅 (Marketing Automation) ───

enum AutomationRuleType {
  BIRTHDAY              // 생일 축하
  CHURN_PREVENTION      // 이탈 방지
  ANNIVERSARY           // 가입 기념일
  FIRST_VISIT_FOLLOWUP  // 첫 방문 팔로업
  VIP_MILESTONE         // VIP 마일스톤
  WINBACK               // 장기 미방문 윈백
  SLOW_DAY              // 비수기 프로모션
}

// 자동화 규칙 (매장별 시나리오 ON/OFF + 설정)
model AutomationRule {
  id        String   @id @default(cuid())
  storeId   String
  store     Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)

  type      AutomationRuleType
  enabled   Boolean  @default(false)

  // 트리거 설정 (JSON)
  // BIRTHDAY: { daysBefore: 3 }
  // CHURN_PREVENTION: { daysInactive: 30 }
  triggerConfig Json   @default("{}")

  // 쿠폰 설정
  couponEnabled      Boolean @default(true)
  couponContent      String?  // "생일 축하 10% 할인" 등
  couponDiscountType String?  // "PERCENT" | "FIXED"
  couponDiscountValue Int?    // 10 (%) 또는 3000 (원)
  couponValidDays    Int     @default(14)

  // 메시지 설정
  messageTemplate    String? @db.Text // 커스텀 메시지 (null이면 기본 템플릿)

  // 발송 제한
  cooldownDays       Int     @default(60)
  monthlyMaxSends    Int?    // null = 제한 없음
  sendTimeHour       Int     @default(10) // 발송 시각 (0-23)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  logs AutomationLog[]

  @@unique([storeId, type])
  @@index([enabled])
  @@map("automation_rules")
}

// 자동화 실행 로그 (발송 이력 + ROI 추적)
model AutomationLog {
  id               String   @id @default(cuid())
  automationRuleId String
  rule             AutomationRule @relation(fields: [automationRuleId], references: [id], onDelete: Cascade)
  storeId          String
  store            Store    @relation(fields: [storeId], references: [id], onDelete: Cascade)
  customerId       String
  customer         Customer @relation(fields: [customerId], references: [id], onDelete: Cascade)

  // 발송 정보
  sentAt           DateTime @default(now())
  alimtalkOutboxId String?  // AlimTalkOutbox 참조
  couponId         String?  // RetargetCoupon 참조
  couponCode       String?

  // 결과 추적
  couponUsed       Boolean  @default(false)
  couponUsedAt     DateTime?
  resultAmount     Int?     // 쿠폰 사용 시 결제 금액

  createdAt        DateTime @default(now())

  @@index([automationRuleId, customerId, sentAt])
  @@index([storeId, sentAt])
  @@index([couponCode])
  @@map("automation_logs")
}

// ─── 보상 수령 신청 ───

enum RewardClaimStatus {
  PENDING     // 신청 대기
  COMPLETED   // 수령 완료
  REJECTED    // 거절
}

model RewardClaim {
  id                    String             @id @default(cuid())
  franchiseId           String
  franchiseCustomerId   String
  tier                  Int                // 사용 스탬프 수 (5, 10, ...)
  rewardDescription     String             // 보상 내용
  status                RewardClaimStatus  @default(PENDING)
  customerName          String?            // 신청 시점 이름 (원본)
  customerPhone         String?            // 신청 시점 연락처 (원본, 대시보드 노출)
  stampLedgerId         String?            // 연결된 FranchiseStampLedger ID
  processedAt           DateTime?          // 처리 완료 시각
  createdAt             DateTime           @default(now())

  franchise             Franchise          @relation(fields: [franchiseId], references: [id])
  franchiseCustomer     FranchiseCustomer  @relation(fields: [franchiseCustomerId], references: [id])

  @@index([franchiseId, status])
  @@index([franchiseCustomerId])
  @@index([createdAt])
  @@map("reward_claims")
}
